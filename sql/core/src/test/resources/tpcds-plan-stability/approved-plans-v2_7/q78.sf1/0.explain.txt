== Parsed Logical Plan ==
CTE [ws, cs, ss]
:  :- 'SubqueryAlias ws
:  :  +- 'Aggregate ['d_year, 'ws_item_sk, 'ws_bill_customer_sk], ['d_year AS ws_sold_year#1, 'ws_item_sk, 'ws_bill_customer_sk AS ws_customer_sk#2, 'sum('ws_quantity) AS ws_qty#3, 'sum('ws_wholesale_cost) AS ws_wc#4, 'sum('ws_sales_price) AS ws_sp#5]
:  :     +- 'Filter isnull('wr_order_number)
:  :        +- 'Join Inner, ('ws_sold_date_sk = 'd_date_sk)
:  :           :- 'Join LeftOuter, (('wr_order_number = 'ws_order_number) AND ('ws_item_sk = 'wr_item_sk))
:  :           :  :- 'UnresolvedRelation [web_sales]
:  :           :  +- 'UnresolvedRelation [web_returns]
:  :           +- 'UnresolvedRelation [date_dim]
:  :- 'SubqueryAlias cs
:  :  +- 'Aggregate ['d_year, 'cs_item_sk, 'cs_bill_customer_sk], ['d_year AS cs_sold_year#6, 'cs_item_sk, 'cs_bill_customer_sk AS cs_customer_sk#7, 'sum('cs_quantity) AS cs_qty#8, 'sum('cs_wholesale_cost) AS cs_wc#9, 'sum('cs_sales_price) AS cs_sp#10]
:  :     +- 'Filter isnull('cr_order_number)
:  :        +- 'Join Inner, ('cs_sold_date_sk = 'd_date_sk)
:  :           :- 'Join LeftOuter, (('cr_order_number = 'cs_order_number) AND ('cs_item_sk = 'cr_item_sk))
:  :           :  :- 'UnresolvedRelation [catalog_sales]
:  :           :  +- 'UnresolvedRelation [catalog_returns]
:  :           +- 'UnresolvedRelation [date_dim]
:  +- 'SubqueryAlias ss
:     +- 'Aggregate ['d_year, 'ss_item_sk, 'ss_customer_sk], ['d_year AS ss_sold_year#11, 'ss_item_sk, 'ss_customer_sk, 'sum('ss_quantity) AS ss_qty#12, 'sum('ss_wholesale_cost) AS ss_wc#13, 'sum('ss_sales_price) AS ss_sp#14]
:        +- 'Filter isnull('sr_ticket_number)
:           +- 'Join Inner, ('ss_sold_date_sk = 'd_date_sk)
:              :- 'Join LeftOuter, (('sr_ticket_number = 'ss_ticket_number) AND ('ss_item_sk = 'sr_item_sk))
:              :  :- 'UnresolvedRelation [store_sales]
:              :  +- 'UnresolvedRelation [store_returns]
:              +- 'UnresolvedRelation [date_dim]
+- 'GlobalLimit 100
   +- 'LocalLimit 100
      +- 'Sort ['ss_sold_year ASC NULLS FIRST, 'ss_item_sk ASC NULLS FIRST, 'ss_customer_sk ASC NULLS FIRST, 'ss_qty DESC NULLS LAST, 'ss_wc DESC NULLS LAST, 'ss_sp DESC NULLS LAST, 'other_chan_qty ASC NULLS FIRST, 'other_chan_wholesale_cost ASC NULLS FIRST, 'other_chan_sales_price ASC NULLS FIRST, 'ratio ASC NULLS FIRST], true
         +- 'Project ['round(('ss_qty / 'coalesce(('ws_qty + 'cs_qty), 1)), 2) AS ratio#15, 'ss_qty AS store_qty#16, 'ss_wc AS store_wholesale_cost#17, 'ss_sp AS store_sales_price#18, ('coalesce('ws_qty, 0) + 'coalesce('cs_qty, 0)) AS other_chan_qty#19, ('coalesce('ws_wc, 0) + 'coalesce('cs_wc, 0)) AS other_chan_wholesale_cost#20, ('coalesce('ws_sp, 0) + 'coalesce('cs_sp, 0)) AS other_chan_sales_price#21]
            +- 'Filter ((('coalesce('ws_qty, 0) > 0) AND ('coalesce('cs_qty, 0) > 0)) AND ('ss_sold_year = 2000))
               +- 'Join LeftOuter, ((('cs_sold_year = 'ss_sold_year) AND ('cs_item_sk = 'ss_item_sk)) AND ('cs_customer_sk = 'ss_customer_sk))
                  :- 'Join LeftOuter, ((('ws_sold_year = 'ss_sold_year) AND ('ws_item_sk = 'ss_item_sk)) AND ('ws_customer_sk = 'ss_customer_sk))
                  :  :- 'UnresolvedRelation [ss]
                  :  +- 'UnresolvedRelation [ws]
                  +- 'UnresolvedRelation [cs]

== Analyzed Logical Plan ==
ratio: double, store_qty: bigint, store_wholesale_cost: decimal(17,2), store_sales_price: decimal(17,2), other_chan_qty: bigint, other_chan_wholesale_cost: decimal(18,2), other_chan_sales_price: decimal(18,2)
GlobalLimit 100
+- LocalLimit 100
   +- Project [ratio#15, store_qty#22, store_wholesale_cost#17, store_sales_price#18, other_chan_qty#23, other_chan_wholesale_cost#20, other_chan_sales_price#21]
      +- Sort [ss_sold_year#11 ASC NULLS FIRST, ss_item_sk#24 ASC NULLS FIRST, ss_customer_sk#25 ASC NULLS FIRST, ss_qty#26 DESC NULLS LAST, ss_wc#13 DESC NULLS LAST, ss_sp#14 DESC NULLS LAST, other_chan_qty#23 ASC NULLS FIRST, other_chan_wholesale_cost#20 ASC NULLS FIRST, other_chan_sales_price#21 ASC NULLS FIRST, ratio#15 ASC NULLS FIRST], true
         +- Project [round((cast(ss_qty#26 as double) / cast(coalesce((ws_qty#27 + cs_qty#28), cast(1 as bigint)) as double)), 2) AS ratio#15, ss_qty#26 AS store_qty#22, ss_wc#13 AS store_wholesale_cost#17, ss_sp#14 AS store_sales_price#18, (coalesce(ws_qty#27, cast(0 as bigint)) + coalesce(cs_qty#28, cast(0 as bigint))) AS other_chan_qty#23, CheckOverflow((promote_precision(cast(coalesce(ws_wc#4, cast(0 as decimal(17,2))) as decimal(18,2))) + promote_precision(cast(coalesce(cs_wc#9, cast(0 as decimal(17,2))) as decimal(18,2)))), DecimalType(18,2), true) AS other_chan_wholesale_cost#20, CheckOverflow((promote_precision(cast(coalesce(ws_sp#5, cast(0 as decimal(17,2))) as decimal(18,2))) + promote_precision(cast(coalesce(cs_sp#10, cast(0 as decimal(17,2))) as decimal(18,2)))), DecimalType(18,2), true) AS other_chan_sales_price#21, ss_sp#14, ss_sold_year#11, ss_qty#26, ss_item_sk#24, ss_customer_sk#25, ss_wc#13]
            +- Filter (((coalesce(ws_qty#27, cast(0 as bigint)) > cast(0 as bigint)) AND (coalesce(cs_qty#28, cast(0 as bigint)) > cast(0 as bigint))) AND (ss_sold_year#11 = 2000))
               +- Join LeftOuter, (((cs_sold_year#6 = ss_sold_year#11) AND (cs_item_sk#29 = ss_item_sk#24)) AND (cs_customer_sk#7 = ss_customer_sk#25))
                  :- Join LeftOuter, (((ws_sold_year#1 = ss_sold_year#11) AND (ws_item_sk#30 = ss_item_sk#24)) AND (ws_customer_sk#2 = ss_customer_sk#25))
                  :  :- SubqueryAlias ss
                  :  :  +- Aggregate [d_year#31, ss_item_sk#24, ss_customer_sk#25], [d_year#31 AS ss_sold_year#11, ss_item_sk#24, ss_customer_sk#25, sum(cast(ss_quantity#32 as bigint)) AS ss_qty#26, sum(ss_wholesale_cost#33) AS ss_wc#13, sum(ss_sales_price#34) AS ss_sp#14]
                  :  :     +- Filter isnull(sr_ticket_number#35)
                  :  :        +- Join Inner, (ss_sold_date_sk#36 = d_date_sk#37)
                  :  :           :- Join LeftOuter, ((sr_ticket_number#35 = cast(ss_ticket_number#38 as bigint)) AND (cast(ss_item_sk#24 as bigint) = sr_item_sk#39))
                  :  :           :  :- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.store_sales
                  :  :           :  :  +- Relation[ss_sold_date_sk#36,ss_sold_time_sk#40,ss_item_sk#24,ss_customer_sk#25,ss_cdemo_sk#41,ss_hdemo_sk#42,ss_addr_sk#43,ss_store_sk#44,ss_promo_sk#45,ss_ticket_number#38,ss_quantity#32,ss_wholesale_cost#33,ss_list_price#46,ss_sales_price#34,ss_ext_discount_amt#47,ss_ext_sales_price#48,ss_ext_wholesale_cost#49,ss_ext_list_price#50,ss_ext_tax#51,ss_coupon_amt#52,ss_net_paid#53,ss_net_paid_inc_tax#54,ss_net_profit#55] parquet
                  :  :           :  +- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.store_returns
                  :  :           :     +- Relation[sr_returned_date_sk#56,sr_return_time_sk#57,sr_item_sk#39,sr_customer_sk#58,sr_cdemo_sk#59,sr_hdemo_sk#60,sr_addr_sk#61,sr_store_sk#62,sr_reason_sk#63,sr_ticket_number#35,sr_return_quantity#64,sr_return_amt#65,sr_return_tax#66,sr_return_amt_inc_tax#67,sr_fee#68,sr_return_ship_cost#69,sr_refunded_cash#70,sr_reversed_charge#71,sr_store_credit#72,sr_net_loss#73] parquet
                  :  :           +- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.date_dim
                  :  :              +- Relation[d_date_sk#37,d_date_id#74,d_date#75,d_month_seq#76,d_week_seq#77,d_quarter_seq#78,d_year#31,d_dow#79,d_moy#80,d_dom#81,d_qoy#82,d_fy_year#83,d_fy_quarter_seq#84,d_fy_week_seq#85,d_day_name#86,d_quarter_name#87,d_holiday#88,d_weekend#89,d_following_holiday#90,d_first_dom#91,d_last_dom#92,d_same_day_ly#93,d_same_day_lq#94,d_current_day#95,... 4 more fields] parquet
                  :  +- SubqueryAlias ws
                  :     +- Aggregate [d_year#31, ws_item_sk#30, ws_bill_customer_sk#96], [d_year#31 AS ws_sold_year#1, ws_item_sk#30, ws_bill_customer_sk#96 AS ws_customer_sk#2, sum(cast(ws_quantity#97 as bigint)) AS ws_qty#27, sum(ws_wholesale_cost#98) AS ws_wc#4, sum(ws_sales_price#99) AS ws_sp#5]
                  :        +- Filter isnull(wr_order_number#100)
                  :           +- Join Inner, (ws_sold_date_sk#101 = d_date_sk#37)
                  :              :- Join LeftOuter, ((wr_order_number#100 = cast(ws_order_number#102 as bigint)) AND (cast(ws_item_sk#30 as bigint) = wr_item_sk#103))
                  :              :  :- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.web_sales
                  :              :  :  +- Relation[ws_sold_date_sk#101,ws_sold_time_sk#104,ws_ship_date_sk#105,ws_item_sk#30,ws_bill_customer_sk#96,ws_bill_cdemo_sk#106,ws_bill_hdemo_sk#107,ws_bill_addr_sk#108,ws_ship_customer_sk#109,ws_ship_cdemo_sk#110,ws_ship_hdemo_sk#111,ws_ship_addr_sk#112,ws_web_page_sk#113,ws_web_site_sk#114,ws_ship_mode_sk#115,ws_warehouse_sk#116,ws_promo_sk#117,ws_order_number#102,ws_quantity#97,ws_wholesale_cost#98,ws_list_price#118,ws_sales_price#99,ws_ext_discount_amt#119,ws_ext_sales_price#120,... 10 more fields] parquet
                  :              :  +- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.web_returns
                  :              :     +- Relation[wr_returned_date_sk#121,wr_returned_time_sk#122,wr_item_sk#103,wr_refunded_customer_sk#123,wr_refunded_cdemo_sk#124,wr_refunded_hdemo_sk#125,wr_refunded_addr_sk#126,wr_returning_customer_sk#127,wr_returning_cdemo_sk#128,wr_returning_hdemo_sk#129,wr_returning_addr_sk#130,wr_web_page_sk#131,wr_reason_sk#132,wr_order_number#100,wr_return_quantity#133,wr_return_amt#134,wr_return_tax#135,wr_return_amt_inc_tax#136,wr_fee#137,wr_return_ship_cost#138,wr_refunded_cash#139,wr_reversed_charge#140,wr_account_credit#141,wr_net_loss#142] parquet
                  :              +- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.date_dim
                  :                 +- Relation[d_date_sk#37,d_date_id#74,d_date#75,d_month_seq#76,d_week_seq#77,d_quarter_seq#78,d_year#31,d_dow#79,d_moy#80,d_dom#81,d_qoy#82,d_fy_year#83,d_fy_quarter_seq#84,d_fy_week_seq#85,d_day_name#86,d_quarter_name#87,d_holiday#88,d_weekend#89,d_following_holiday#90,d_first_dom#91,d_last_dom#92,d_same_day_ly#93,d_same_day_lq#94,d_current_day#95,... 4 more fields] parquet
                  +- SubqueryAlias cs
                     +- Aggregate [d_year#31, cs_item_sk#29, cs_bill_customer_sk#143], [d_year#31 AS cs_sold_year#6, cs_item_sk#29, cs_bill_customer_sk#143 AS cs_customer_sk#7, sum(cast(cs_quantity#144 as bigint)) AS cs_qty#28, sum(cs_wholesale_cost#145) AS cs_wc#9, sum(cs_sales_price#146) AS cs_sp#10]
                        +- Filter isnull(cr_order_number#147)
                           +- Join Inner, (cs_sold_date_sk#148 = d_date_sk#37)
                              :- Join LeftOuter, ((cr_order_number#147 = cs_order_number#149) AND (cs_item_sk#29 = cr_item_sk#150))
                              :  :- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.catalog_sales
                              :  :  +- Relation[cs_sold_date_sk#148,cs_sold_time_sk#151,cs_ship_date_sk#152,cs_bill_customer_sk#143,cs_bill_cdemo_sk#153,cs_bill_hdemo_sk#154,cs_bill_addr_sk#155,cs_ship_customer_sk#156,cs_ship_cdemo_sk#157,cs_ship_hdemo_sk#158,cs_ship_addr_sk#159,cs_call_center_sk#160,cs_catalog_page_sk#161,cs_ship_mode_sk#162,cs_warehouse_sk#163,cs_item_sk#29,cs_promo_sk#164,cs_order_number#149,cs_quantity#144,cs_wholesale_cost#145,cs_list_price#165,cs_sales_price#146,cs_ext_discount_amt#166,cs_ext_sales_price#167,... 10 more fields] parquet
                              :  +- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.catalog_returns
                              :     +- Relation[cr_returned_date_sk#168,cr_returned_time_sk#169,cr_item_sk#150,cr_refunded_customer_sk#170,cr_refunded_cdemo_sk#171,cr_refunded_hdemo_sk#172,cr_refunded_addr_sk#173,cr_returning_customer_sk#174,cr_returning_cdemo_sk#175,cr_returning_hdemo_sk#176,cr_returning_addr_sk#177,cr_call_center_sk#178,cr_catalog_page_sk#179,cr_ship_mode_sk#180,cr_warehouse_sk#181,cr_reason_sk#182,cr_order_number#147,cr_return_quantity#183,cr_return_amount#184,cr_return_tax#185,cr_return_amt_inc_tax#186,cr_fee#187,cr_return_ship_cost#188,cr_refunded_cash#189,... 3 more fields] parquet
                              +- SubqueryAlias spark_catalog.tpcds_sf1_parquet_stats.date_dim
                                 +- Relation[d_date_sk#37,d_date_id#74,d_date#75,d_month_seq#76,d_week_seq#77,d_quarter_seq#78,d_year#31,d_dow#79,d_moy#80,d_dom#81,d_qoy#82,d_fy_year#83,d_fy_quarter_seq#84,d_fy_week_seq#85,d_day_name#86,d_quarter_name#87,d_holiday#88,d_weekend#89,d_following_holiday#90,d_first_dom#91,d_last_dom#92,d_same_day_ly#93,d_same_day_lq#94,d_current_day#95,... 4 more fields] parquet

== Optimized Logical Plan ==
GlobalLimit 100
+- LocalLimit 100
   +- Project [ratio#15, store_qty#22, store_wholesale_cost#17, store_sales_price#18, other_chan_qty#23, other_chan_wholesale_cost#20, other_chan_sales_price#21]
      +- Sort [ss_sold_year#11 ASC NULLS FIRST, ss_item_sk#24 ASC NULLS FIRST, ss_customer_sk#25 ASC NULLS FIRST, ss_qty#26 DESC NULLS LAST, ss_wc#13 DESC NULLS LAST, ss_sp#14 DESC NULLS LAST, other_chan_qty#23 ASC NULLS FIRST, other_chan_wholesale_cost#20 ASC NULLS FIRST, other_chan_sales_price#21 ASC NULLS FIRST, ratio#15 ASC NULLS FIRST], true
         +- Project [round((cast(ss_qty#26 as double) / cast(coalesce((ws_qty#27 + cs_qty#28), 1) as double)), 2) AS ratio#15, ss_qty#26 AS store_qty#22, ss_wc#13 AS store_wholesale_cost#17, ss_sp#14 AS store_sales_price#18, (coalesce(ws_qty#27, 0) + coalesce(cs_qty#28, 0)) AS other_chan_qty#23, CheckOverflow((promote_precision(cast(coalesce(ws_wc#4, 0.00) as decimal(18,2))) + promote_precision(cast(coalesce(cs_wc#9, 0.00) as decimal(18,2)))), DecimalType(18,2), true) AS other_chan_wholesale_cost#20, CheckOverflow((promote_precision(cast(coalesce(ws_sp#5, 0.00) as decimal(18,2))) + promote_precision(cast(coalesce(cs_sp#10, 0.00) as decimal(18,2)))), DecimalType(18,2), true) AS other_chan_sales_price#21, ss_sp#14, ss_sold_year#11, ss_qty#26, ss_item_sk#24, ss_customer_sk#25, ss_wc#13]
            +- Join Inner, (((cs_sold_year#6 = ss_sold_year#11) AND (cs_item_sk#29 = ss_item_sk#24)) AND (cs_customer_sk#7 = ss_customer_sk#25))
               :- Project [ss_sold_year#11, ss_item_sk#24, ss_customer_sk#25, ss_qty#26, ss_wc#13, ss_sp#14, ws_qty#27, ws_wc#4, ws_sp#5]
               :  +- Join Inner, (((ws_sold_year#1 = ss_sold_year#11) AND (ws_item_sk#30 = ss_item_sk#24)) AND (ws_customer_sk#2 = ss_customer_sk#25))
               :     :- Aggregate [d_year#31, ss_item_sk#24, ss_customer_sk#25], [d_year#31 AS ss_sold_year#11, ss_item_sk#24, ss_customer_sk#25, sum(cast(ss_quantity#32 as bigint)) AS ss_qty#26, MakeDecimal(sum(UnscaledValue(ss_wholesale_cost#33)),17,2) AS ss_wc#13, MakeDecimal(sum(UnscaledValue(ss_sales_price#34)),17,2) AS ss_sp#14]
               :     :  +- Project [ss_item_sk#24, ss_customer_sk#25, ss_quantity#32, ss_wholesale_cost#33, ss_sales_price#34, d_year#31]
               :     :     +- Join Inner, (ss_sold_date_sk#36 = d_date_sk#37)
               :     :        :- Project [ss_sold_date_sk#36, ss_item_sk#24, ss_customer_sk#25, ss_quantity#32, ss_wholesale_cost#33, ss_sales_price#34]
               :     :        :  +- Filter isnull(sr_ticket_number#35)
               :     :        :     +- Join LeftOuter, ((sr_ticket_number#35 = cast(ss_ticket_number#38 as bigint)) AND (cast(ss_item_sk#24 as bigint) = sr_item_sk#39))
               :     :        :        :- Project [ss_sold_date_sk#36, ss_item_sk#24, ss_customer_sk#25, ss_ticket_number#38, ss_quantity#32, ss_wholesale_cost#33, ss_sales_price#34]
               :     :        :        :  +- Filter ((isnotnull(ss_sold_date_sk#36) AND isnotnull(ss_customer_sk#25)) AND isnotnull(ss_item_sk#24))
               :     :        :        :     +- Relation[ss_sold_date_sk#36,ss_sold_time_sk#40,ss_item_sk#24,ss_customer_sk#25,ss_cdemo_sk#41,ss_hdemo_sk#42,ss_addr_sk#43,ss_store_sk#44,ss_promo_sk#45,ss_ticket_number#38,ss_quantity#32,ss_wholesale_cost#33,ss_list_price#46,ss_sales_price#34,ss_ext_discount_amt#47,ss_ext_sales_price#48,ss_ext_wholesale_cost#49,ss_ext_list_price#50,ss_ext_tax#51,ss_coupon_amt#52,ss_net_paid#53,ss_net_paid_inc_tax#54,ss_net_profit#55] parquet
               :     :        :        +- Project [sr_item_sk#39, sr_ticket_number#35]
               :     :        :           +- Filter (isnotnull(sr_ticket_number#35) AND isnotnull(sr_item_sk#39))
               :     :        :              +- Relation[sr_returned_date_sk#56,sr_return_time_sk#57,sr_item_sk#39,sr_customer_sk#58,sr_cdemo_sk#59,sr_hdemo_sk#60,sr_addr_sk#61,sr_store_sk#62,sr_reason_sk#63,sr_ticket_number#35,sr_return_quantity#64,sr_return_amt#65,sr_return_tax#66,sr_return_amt_inc_tax#67,sr_fee#68,sr_return_ship_cost#69,sr_refunded_cash#70,sr_reversed_charge#71,sr_store_credit#72,sr_net_loss#73] parquet
               :     :        +- Project [d_date_sk#37, d_year#31]
               :     :           +- Filter ((isnotnull(d_year#31) AND (d_year#31 = 2000)) AND isnotnull(d_date_sk#37))
               :     :              +- Relation[d_date_sk#37,d_date_id#74,d_date#75,d_month_seq#76,d_week_seq#77,d_quarter_seq#78,d_year#31,d_dow#79,d_moy#80,d_dom#81,d_qoy#82,d_fy_year#83,d_fy_quarter_seq#84,d_fy_week_seq#85,d_day_name#86,d_quarter_name#87,d_holiday#88,d_weekend#89,d_following_holiday#90,d_first_dom#91,d_last_dom#92,d_same_day_ly#93,d_same_day_lq#94,d_current_day#95,... 4 more fields] parquet
               :     +- Filter (coalesce(ws_qty#27, 0) > 0)
               :        +- Aggregate [d_year#31, ws_item_sk#30, ws_bill_customer_sk#96], [d_year#31 AS ws_sold_year#1, ws_item_sk#30, ws_bill_customer_sk#96 AS ws_customer_sk#2, sum(cast(ws_quantity#97 as bigint)) AS ws_qty#27, MakeDecimal(sum(UnscaledValue(ws_wholesale_cost#98)),17,2) AS ws_wc#4, MakeDecimal(sum(UnscaledValue(ws_sales_price#99)),17,2) AS ws_sp#5]
               :           +- Project [ws_item_sk#30, ws_bill_customer_sk#96, ws_quantity#97, ws_wholesale_cost#98, ws_sales_price#99, d_year#31]
               :              +- Join Inner, (ws_sold_date_sk#101 = d_date_sk#37)
               :                 :- Project [ws_sold_date_sk#101, ws_item_sk#30, ws_bill_customer_sk#96, ws_quantity#97, ws_wholesale_cost#98, ws_sales_price#99]
               :                 :  +- Filter isnull(wr_order_number#100)
               :                 :     +- Join LeftOuter, ((wr_order_number#100 = cast(ws_order_number#102 as bigint)) AND (cast(ws_item_sk#30 as bigint) = wr_item_sk#103))
               :                 :        :- Project [ws_sold_date_sk#101, ws_item_sk#30, ws_bill_customer_sk#96, ws_order_number#102, ws_quantity#97, ws_wholesale_cost#98, ws_sales_price#99]
               :                 :        :  +- Filter ((isnotnull(ws_sold_date_sk#101) AND isnotnull(ws_bill_customer_sk#96)) AND isnotnull(ws_item_sk#30))
               :                 :        :     +- Relation[ws_sold_date_sk#101,ws_sold_time_sk#104,ws_ship_date_sk#105,ws_item_sk#30,ws_bill_customer_sk#96,ws_bill_cdemo_sk#106,ws_bill_hdemo_sk#107,ws_bill_addr_sk#108,ws_ship_customer_sk#109,ws_ship_cdemo_sk#110,ws_ship_hdemo_sk#111,ws_ship_addr_sk#112,ws_web_page_sk#113,ws_web_site_sk#114,ws_ship_mode_sk#115,ws_warehouse_sk#116,ws_promo_sk#117,ws_order_number#102,ws_quantity#97,ws_wholesale_cost#98,ws_list_price#118,ws_sales_price#99,ws_ext_discount_amt#119,ws_ext_sales_price#120,... 10 more fields] parquet
               :                 :        +- Project [wr_item_sk#103, wr_order_number#100]
               :                 :           +- Filter (isnotnull(wr_order_number#100) AND isnotnull(wr_item_sk#103))
               :                 :              +- Relation[wr_returned_date_sk#121,wr_returned_time_sk#122,wr_item_sk#103,wr_refunded_customer_sk#123,wr_refunded_cdemo_sk#124,wr_refunded_hdemo_sk#125,wr_refunded_addr_sk#126,wr_returning_customer_sk#127,wr_returning_cdemo_sk#128,wr_returning_hdemo_sk#129,wr_returning_addr_sk#130,wr_web_page_sk#131,wr_reason_sk#132,wr_order_number#100,wr_return_quantity#133,wr_return_amt#134,wr_return_tax#135,wr_return_amt_inc_tax#136,wr_fee#137,wr_return_ship_cost#138,wr_refunded_cash#139,wr_reversed_charge#140,wr_account_credit#141,wr_net_loss#142] parquet
               :                 +- Project [d_date_sk#37, d_year#31]
               :                    +- Filter ((isnotnull(d_date_sk#37) AND isnotnull(d_year#31)) AND (d_year#31 = 2000))
               :                       +- Relation[d_date_sk#37,d_date_id#74,d_date#75,d_month_seq#76,d_week_seq#77,d_quarter_seq#78,d_year#31,d_dow#79,d_moy#80,d_dom#81,d_qoy#82,d_fy_year#83,d_fy_quarter_seq#84,d_fy_week_seq#85,d_day_name#86,d_quarter_name#87,d_holiday#88,d_weekend#89,d_following_holiday#90,d_first_dom#91,d_last_dom#92,d_same_day_ly#93,d_same_day_lq#94,d_current_day#95,... 4 more fields] parquet
               +- Filter (coalesce(cs_qty#28, 0) > 0)
                  +- Aggregate [d_year#31, cs_item_sk#29, cs_bill_customer_sk#143], [d_year#31 AS cs_sold_year#6, cs_item_sk#29, cs_bill_customer_sk#143 AS cs_customer_sk#7, sum(cast(cs_quantity#144 as bigint)) AS cs_qty#28, MakeDecimal(sum(UnscaledValue(cs_wholesale_cost#145)),17,2) AS cs_wc#9, MakeDecimal(sum(UnscaledValue(cs_sales_price#146)),17,2) AS cs_sp#10]
                     +- Project [cs_bill_customer_sk#143, cs_item_sk#29, cs_quantity#144, cs_wholesale_cost#145, cs_sales_price#146, d_year#31]
                        +- Join Inner, (cs_sold_date_sk#148 = d_date_sk#37)
                           :- Project [cs_sold_date_sk#148, cs_bill_customer_sk#143, cs_item_sk#29, cs_quantity#144, cs_wholesale_cost#145, cs_sales_price#146]
                           :  +- Filter isnull(cr_order_number#147)
                           :     +- Join LeftOuter, ((cr_order_number#147 = cs_order_number#149) AND (cs_item_sk#29 = cr_item_sk#150))
                           :        :- Project [cs_sold_date_sk#148, cs_bill_customer_sk#143, cs_item_sk#29, cs_order_number#149, cs_quantity#144, cs_wholesale_cost#145, cs_sales_price#146]
                           :        :  +- Filter ((isnotnull(cs_sold_date_sk#148) AND isnotnull(cs_bill_customer_sk#143)) AND isnotnull(cs_item_sk#29))
                           :        :     +- Relation[cs_sold_date_sk#148,cs_sold_time_sk#151,cs_ship_date_sk#152,cs_bill_customer_sk#143,cs_bill_cdemo_sk#153,cs_bill_hdemo_sk#154,cs_bill_addr_sk#155,cs_ship_customer_sk#156,cs_ship_cdemo_sk#157,cs_ship_hdemo_sk#158,cs_ship_addr_sk#159,cs_call_center_sk#160,cs_catalog_page_sk#161,cs_ship_mode_sk#162,cs_warehouse_sk#163,cs_item_sk#29,cs_promo_sk#164,cs_order_number#149,cs_quantity#144,cs_wholesale_cost#145,cs_list_price#165,cs_sales_price#146,cs_ext_discount_amt#166,cs_ext_sales_price#167,... 10 more fields] parquet
                           :        +- Project [cr_item_sk#150, cr_order_number#147]
                           :           +- Filter (isnotnull(cr_order_number#147) AND isnotnull(cr_item_sk#150))
                           :              +- Relation[cr_returned_date_sk#168,cr_returned_time_sk#169,cr_item_sk#150,cr_refunded_customer_sk#170,cr_refunded_cdemo_sk#171,cr_refunded_hdemo_sk#172,cr_refunded_addr_sk#173,cr_returning_customer_sk#174,cr_returning_cdemo_sk#175,cr_returning_hdemo_sk#176,cr_returning_addr_sk#177,cr_call_center_sk#178,cr_catalog_page_sk#179,cr_ship_mode_sk#180,cr_warehouse_sk#181,cr_reason_sk#182,cr_order_number#147,cr_return_quantity#183,cr_return_amount#184,cr_return_tax#185,cr_return_amt_inc_tax#186,cr_fee#187,cr_return_ship_cost#188,cr_refunded_cash#189,... 3 more fields] parquet
                           +- Project [d_date_sk#37, d_year#31]
                              +- Filter ((isnotnull(d_date_sk#37) AND isnotnull(d_year#31)) AND (d_year#31 = 2000))
                                 +- Relation[d_date_sk#37,d_date_id#74,d_date#75,d_month_seq#76,d_week_seq#77,d_quarter_seq#78,d_year#31,d_dow#79,d_moy#80,d_dom#81,d_qoy#82,d_fy_year#83,d_fy_quarter_seq#84,d_fy_week_seq#85,d_day_name#86,d_quarter_name#87,d_holiday#88,d_weekend#89,d_following_holiday#90,d_first_dom#91,d_last_dom#92,d_same_day_ly#93,d_same_day_lq#94,d_current_day#95,... 4 more fields] parquet

== Physical Plan ==
TakeOrderedAndProject(limit=100, orderBy=[ss_sold_year#11 ASC NULLS FIRST,ss_item_sk#24 ASC NULLS FIRST,ss_customer_sk#25 ASC NULLS FIRST,ss_qty#26 DESC NULLS LAST,ss_wc#13 DESC NULLS LAST,ss_sp#14 DESC NULLS LAST,other_chan_qty#23 ASC NULLS FIRST,other_chan_wholesale_cost#20 ASC NULLS FIRST,other_chan_sales_price#21 ASC NULLS FIRST,ratio#15 ASC NULLS FIRST], output=[ratio#15,store_qty#22,store_wholesale_cost#17,store_sales_price#18,other_chan_qty#23,other_chan_wholesale_cost#20,other_chan_sales_price#21])
+- *(14) Project [round((cast(ss_qty#26 as double) / cast(coalesce((ws_qty#27 + cs_qty#28), 1) as double)), 2) AS ratio#15, ss_qty#26 AS store_qty#22, ss_wc#13 AS store_wholesale_cost#17, ss_sp#14 AS store_sales_price#18, (coalesce(ws_qty#27, 0) + coalesce(cs_qty#28, 0)) AS other_chan_qty#23, CheckOverflow((promote_precision(cast(coalesce(ws_wc#4, 0.00) as decimal(18,2))) + promote_precision(cast(coalesce(cs_wc#9, 0.00) as decimal(18,2)))), DecimalType(18,2), true) AS other_chan_wholesale_cost#20, CheckOverflow((promote_precision(cast(coalesce(ws_sp#5, 0.00) as decimal(18,2))) + promote_precision(cast(coalesce(cs_sp#10, 0.00) as decimal(18,2)))), DecimalType(18,2), true) AS other_chan_sales_price#21, ss_sp#14, ss_sold_year#11, ss_qty#26, ss_item_sk#24, ss_customer_sk#25, ss_wc#13]
   +- *(14) SortMergeJoin [ss_sold_year#11, ss_item_sk#24, ss_customer_sk#25], [cs_sold_year#6, cs_item_sk#29, cs_customer_sk#7], Inner
      :- *(9) Project [ss_sold_year#11, ss_item_sk#24, ss_customer_sk#25, ss_qty#26, ss_wc#13, ss_sp#14, ws_qty#27, ws_wc#4, ws_sp#5]
      :  +- *(9) SortMergeJoin [ss_sold_year#11, ss_item_sk#24, ss_customer_sk#25], [ws_sold_year#1, ws_item_sk#30, ws_customer_sk#2], Inner
      :     :- *(4) Sort [ss_sold_year#11 ASC NULLS FIRST, ss_item_sk#24 ASC NULLS FIRST, ss_customer_sk#25 ASC NULLS FIRST], false, 0
      :     :  +- *(4) HashAggregate(keys=[d_year#31, ss_item_sk#24, ss_customer_sk#25], functions=[sum(cast(ss_quantity#32 as bigint)), sum(UnscaledValue(ss_wholesale_cost#33)), sum(UnscaledValue(ss_sales_price#34))], output=[ss_sold_year#11, ss_item_sk#24, ss_customer_sk#25, ss_qty#26, ss_wc#13, ss_sp#14])
      :     :     +- Exchange hashpartitioning(d_year#31, ss_item_sk#24, ss_customer_sk#25, 5), true, [id=#190]
      :     :        +- *(3) HashAggregate(keys=[d_year#31, ss_item_sk#24, ss_customer_sk#25], functions=[partial_sum(cast(ss_quantity#32 as bigint)), partial_sum(UnscaledValue(ss_wholesale_cost#33)), partial_sum(UnscaledValue(ss_sales_price#34))], output=[d_year#31, ss_item_sk#24, ss_customer_sk#25, sum#191, sum#192, sum#193])
      :     :           +- *(3) Project [ss_item_sk#24, ss_customer_sk#25, ss_quantity#32, ss_wholesale_cost#33, ss_sales_price#34, d_year#31]
      :     :              +- *(3) BroadcastHashJoin [ss_sold_date_sk#36], [d_date_sk#37], Inner, BuildRight, false
      :     :                 :- *(3) Project [ss_sold_date_sk#36, ss_item_sk#24, ss_customer_sk#25, ss_quantity#32, ss_wholesale_cost#33, ss_sales_price#34]
      :     :                 :  +- *(3) Filter isnull(sr_ticket_number#35)
      :     :                 :     +- *(3) BroadcastHashJoin [cast(ss_ticket_number#38 as bigint), cast(ss_item_sk#24 as bigint)], [sr_ticket_number#35, sr_item_sk#39], LeftOuter, BuildRight, false
      :     :                 :        :- *(3) Project [ss_sold_date_sk#36, ss_item_sk#24, ss_customer_sk#25, ss_ticket_number#38, ss_quantity#32, ss_wholesale_cost#33, ss_sales_price#34]
      :     :                 :        :  +- *(3) Filter ((isnotnull(ss_sold_date_sk#36) AND isnotnull(ss_customer_sk#25)) AND isnotnull(ss_item_sk#24))
      :     :                 :        :     +- *(3) ColumnarToRow
      :     :                 :        :        +- FileScan parquet tpcds_sf1_parquet_stats.store_sales[ss_sold_date_sk#36,ss_item_sk#24,ss_customer_sk#25,ss_ticket_number#38,ss_quantity#32,ss_wholesale_cost#33,ss_sales_price#34] Batched: true, DataFilters: [isnotnull(ss_sold_date_sk#36), isnotnull(ss_customer_sk#25), isnotnull(ss_item_sk#24)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ss_sold_date_sk), IsNotNull(ss_customer_sk), IsNotNull(ss_item_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_item_sk:int,ss_customer_sk:int,ss_ticket_number:int,ss_quantity:int...
      :     :                 :        +- BroadcastExchange HashedRelationBroadcastMode(List(input[1, bigint, true], input[0, bigint, true]),false), [id=#194]
      :     :                 :           +- *(1) Project [sr_item_sk#39, sr_ticket_number#35]
      :     :                 :              +- *(1) Filter (isnotnull(sr_ticket_number#35) AND isnotnull(sr_item_sk#39))
      :     :                 :                 +- *(1) ColumnarToRow
      :     :                 :                    +- FileScan parquet tpcds_sf1_parquet_stats.store_returns[sr_item_sk#39,sr_ticket_number#35] Batched: true, DataFilters: [isnotnull(sr_ticket_number#35), isnotnull(sr_item_sk#39)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(sr_ticket_number), IsNotNull(sr_item_sk)], ReadSchema: struct<sr_item_sk:bigint,sr_ticket_number:bigint>
      :     :                 +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#195]
      :     :                    +- *(2) Project [d_date_sk#37, d_year#31]
      :     :                       +- *(2) Filter ((isnotnull(d_year#31) AND (d_year#31 = 2000)) AND isnotnull(d_date_sk#37))
      :     :                          +- *(2) ColumnarToRow
      :     :                             +- FileScan parquet tpcds_sf1_parquet_stats.date_dim[d_date_sk#37,d_year#31] Batched: true, DataFilters: [isnotnull(d_year#31), (d_year#31 = 2000), isnotnull(d_date_sk#37)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(d_year), EqualTo(d_year,2000), IsNotNull(d_date_sk)], ReadSchema: struct<d_date_sk:int,d_year:int>
      :     +- *(8) Sort [ws_sold_year#1 ASC NULLS FIRST, ws_item_sk#30 ASC NULLS FIRST, ws_customer_sk#2 ASC NULLS FIRST], false, 0
      :        +- *(8) Filter (coalesce(ws_qty#27, 0) > 0)
      :           +- *(8) HashAggregate(keys=[d_year#31, ws_item_sk#30, ws_bill_customer_sk#96], functions=[sum(cast(ws_quantity#97 as bigint)), sum(UnscaledValue(ws_wholesale_cost#98)), sum(UnscaledValue(ws_sales_price#99))], output=[ws_sold_year#1, ws_item_sk#30, ws_customer_sk#2, ws_qty#27, ws_wc#4, ws_sp#5])
      :              +- Exchange hashpartitioning(d_year#31, ws_item_sk#30, ws_bill_customer_sk#96, 5), true, [id=#196]
      :                 +- *(7) HashAggregate(keys=[d_year#31, ws_item_sk#30, ws_bill_customer_sk#96], functions=[partial_sum(cast(ws_quantity#97 as bigint)), partial_sum(UnscaledValue(ws_wholesale_cost#98)), partial_sum(UnscaledValue(ws_sales_price#99))], output=[d_year#31, ws_item_sk#30, ws_bill_customer_sk#96, sum#197, sum#198, sum#199])
      :                    +- *(7) Project [ws_item_sk#30, ws_bill_customer_sk#96, ws_quantity#97, ws_wholesale_cost#98, ws_sales_price#99, d_year#31]
      :                       +- *(7) BroadcastHashJoin [ws_sold_date_sk#101], [d_date_sk#37], Inner, BuildRight, false
      :                          :- *(7) Project [ws_sold_date_sk#101, ws_item_sk#30, ws_bill_customer_sk#96, ws_quantity#97, ws_wholesale_cost#98, ws_sales_price#99]
      :                          :  +- *(7) Filter isnull(wr_order_number#100)
      :                          :     +- *(7) BroadcastHashJoin [cast(ws_order_number#102 as bigint), cast(ws_item_sk#30 as bigint)], [wr_order_number#100, wr_item_sk#103], LeftOuter, BuildRight, false
      :                          :        :- *(7) Project [ws_sold_date_sk#101, ws_item_sk#30, ws_bill_customer_sk#96, ws_order_number#102, ws_quantity#97, ws_wholesale_cost#98, ws_sales_price#99]
      :                          :        :  +- *(7) Filter ((isnotnull(ws_sold_date_sk#101) AND isnotnull(ws_bill_customer_sk#96)) AND isnotnull(ws_item_sk#30))
      :                          :        :     +- *(7) ColumnarToRow
      :                          :        :        +- FileScan parquet tpcds_sf1_parquet_stats.web_sales[ws_sold_date_sk#101,ws_item_sk#30,ws_bill_customer_sk#96,ws_order_number#102,ws_quantity#97,ws_wholesale_cost#98,ws_sales_price#99] Batched: true, DataFilters: [isnotnull(ws_sold_date_sk#101), isnotnull(ws_bill_customer_sk#96), isnotnull(ws_item_sk#30)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ws_sold_date_sk), IsNotNull(ws_bill_customer_sk), IsNotNull(ws_item_sk)], ReadSchema: struct<ws_sold_date_sk:int,ws_item_sk:int,ws_bill_customer_sk:int,ws_order_number:int,ws_quantity...
      :                          :        +- BroadcastExchange HashedRelationBroadcastMode(List(input[1, bigint, true], input[0, bigint, true]),false), [id=#200]
      :                          :           +- *(5) Project [wr_item_sk#103, wr_order_number#100]
      :                          :              +- *(5) Filter (isnotnull(wr_order_number#100) AND isnotnull(wr_item_sk#103))
      :                          :                 +- *(5) ColumnarToRow
      :                          :                    +- FileScan parquet tpcds_sf1_parquet_stats.web_returns[wr_item_sk#103,wr_order_number#100] Batched: true, DataFilters: [isnotnull(wr_order_number#100), isnotnull(wr_item_sk#103)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(wr_order_number), IsNotNull(wr_item_sk)], ReadSchema: struct<wr_item_sk:bigint,wr_order_number:bigint>
      :                          +- ReusedExchange [d_date_sk#37, d_year#31], BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#195]
      +- *(13) Sort [cs_sold_year#6 ASC NULLS FIRST, cs_item_sk#29 ASC NULLS FIRST, cs_customer_sk#7 ASC NULLS FIRST], false, 0
         +- *(13) Filter (coalesce(cs_qty#28, 0) > 0)
            +- *(13) HashAggregate(keys=[d_year#31, cs_item_sk#29, cs_bill_customer_sk#143], functions=[sum(cast(cs_quantity#144 as bigint)), sum(UnscaledValue(cs_wholesale_cost#145)), sum(UnscaledValue(cs_sales_price#146))], output=[cs_sold_year#6, cs_item_sk#29, cs_customer_sk#7, cs_qty#28, cs_wc#9, cs_sp#10])
               +- Exchange hashpartitioning(d_year#31, cs_item_sk#29, cs_bill_customer_sk#143, 5), true, [id=#201]
                  +- *(12) HashAggregate(keys=[d_year#31, cs_item_sk#29, cs_bill_customer_sk#143], functions=[partial_sum(cast(cs_quantity#144 as bigint)), partial_sum(UnscaledValue(cs_wholesale_cost#145)), partial_sum(UnscaledValue(cs_sales_price#146))], output=[d_year#31, cs_item_sk#29, cs_bill_customer_sk#143, sum#202, sum#203, sum#204])
                     +- *(12) Project [cs_bill_customer_sk#143, cs_item_sk#29, cs_quantity#144, cs_wholesale_cost#145, cs_sales_price#146, d_year#31]
                        +- *(12) BroadcastHashJoin [cs_sold_date_sk#148], [d_date_sk#37], Inner, BuildRight, false
                           :- *(12) Project [cs_sold_date_sk#148, cs_bill_customer_sk#143, cs_item_sk#29, cs_quantity#144, cs_wholesale_cost#145, cs_sales_price#146]
                           :  +- *(12) Filter isnull(cr_order_number#147)
                           :     +- *(12) BroadcastHashJoin [cs_order_number#149, cs_item_sk#29], [cr_order_number#147, cr_item_sk#150], LeftOuter, BuildRight, false
                           :        :- *(12) Project [cs_sold_date_sk#148, cs_bill_customer_sk#143, cs_item_sk#29, cs_order_number#149, cs_quantity#144, cs_wholesale_cost#145, cs_sales_price#146]
                           :        :  +- *(12) Filter ((isnotnull(cs_sold_date_sk#148) AND isnotnull(cs_bill_customer_sk#143)) AND isnotnull(cs_item_sk#29))
                           :        :     +- *(12) ColumnarToRow
                           :        :        +- FileScan parquet tpcds_sf1_parquet_stats.catalog_sales[cs_sold_date_sk#148,cs_bill_customer_sk#143,cs_item_sk#29,cs_order_number#149,cs_quantity#144,cs_wholesale_cost#145,cs_sales_price#146] Batched: true, DataFilters: [isnotnull(cs_sold_date_sk#148), isnotnull(cs_bill_customer_sk#143), isnotnull(cs_item_sk#29)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(cs_sold_date_sk), IsNotNull(cs_bill_customer_sk), IsNotNull(cs_item_sk)], ReadSchema: struct<cs_sold_date_sk:int,cs_bill_customer_sk:int,cs_item_sk:int,cs_order_number:int,cs_quantity...
                           :        +- BroadcastExchange HashedRelationBroadcastMode(List((shiftleft(cast(input[1, int, true] as bigint), 32) | (cast(input[0, int, true] as bigint) & 4294967295))),false), [id=#205]
                           :           +- *(10) Project [cr_item_sk#150, cr_order_number#147]
                           :              +- *(10) Filter (isnotnull(cr_order_number#147) AND isnotnull(cr_item_sk#150))
                           :                 +- *(10) ColumnarToRow
                           :                    +- FileScan parquet tpcds_sf1_parquet_stats.catalog_returns[cr_item_sk#150,cr_order_number#147] Batched: true, DataFilters: [isnotnull(cr_order_number#147), isnotnull(cr_item_sk#150)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(cr_order_number), IsNotNull(cr_item_sk)], ReadSchema: struct<cr_item_sk:int,cr_order_number:int>
                           +- ReusedExchange [d_date_sk#37, d_year#31], BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#195]
