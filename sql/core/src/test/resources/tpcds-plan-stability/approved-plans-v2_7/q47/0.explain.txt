== Parsed Logical Plan ==
CTE [v1, v2]
:  :- 'SubqueryAlias v1
:  :  +- 'Aggregate ['i_category, 'i_brand, 's_store_name, 's_company_name, 'd_year, 'd_moy], ['i_category, 'i_brand, 's_store_name, 's_company_name, 'd_year, 'd_moy, 'sum('ss_sales_price) AS sum_sales#1, 'avg('sum('ss_sales_price)) windowspecdefinition('i_category, 'i_brand, 's_store_name, 's_company_name, 'd_year, unspecifiedframe$()) AS avg_monthly_sales#2, 'rank() windowspecdefinition('i_category, 'i_brand, 's_store_name, 's_company_name, 'd_year ASC NULLS FIRST, 'd_moy ASC NULLS FIRST, unspecifiedframe$()) AS rn#3]
:  :     +- 'Filter ((('ss_item_sk = 'i_item_sk) AND ('ss_sold_date_sk = 'd_date_sk)) AND (('ss_store_sk = 's_store_sk) AND ((('d_year = 1999) OR (('d_year = (1999 - 1)) AND ('d_moy = 12))) OR (('d_year = (1999 + 1)) AND ('d_moy = 1)))))
:  :        +- 'Join Inner
:  :           :- 'Join Inner
:  :           :  :- 'Join Inner
:  :           :  :  :- 'UnresolvedRelation [item]
:  :           :  :  +- 'UnresolvedRelation [store_sales]
:  :           :  +- 'UnresolvedRelation [date_dim]
:  :           +- 'UnresolvedRelation [store]
:  +- 'SubqueryAlias v2
:     +- 'Project ['v1.i_category, 'v1.d_year, 'v1.d_moy, 'v1.avg_monthly_sales, 'v1.sum_sales, 'v1_lag.sum_sales AS psum#4, 'v1_lead.sum_sales AS nsum#5]
:        +- 'Filter ((((('v1.i_category = 'v1_lag.i_category) AND ('v1.i_category = 'v1_lead.i_category)) AND ('v1.i_brand = 'v1_lag.i_brand)) AND (('v1.i_brand = 'v1_lead.i_brand) AND ('v1.s_store_name = 'v1_lag.s_store_name))) AND (((('v1.s_store_name = 'v1_lead.s_store_name) AND ('v1.s_company_name = 'v1_lag.s_company_name)) AND ('v1.s_company_name = 'v1_lead.s_company_name)) AND (('v1.rn = ('v1_lag.rn + 1)) AND ('v1.rn = ('v1_lead.rn - 1)))))
:           +- 'Join Inner
:              :- 'Join Inner
:              :  :- 'UnresolvedRelation [v1]
:              :  +- 'SubqueryAlias v1_lag
:              :     +- 'UnresolvedRelation [v1]
:              +- 'SubqueryAlias v1_lead
:                 +- 'UnresolvedRelation [v1]
+- 'GlobalLimit 100
   +- 'LocalLimit 100
      +- 'Sort [('sum_sales - 'avg_monthly_sales) ASC NULLS FIRST, 3 ASC NULLS FIRST], true
         +- 'Project [*]
            +- 'Filter ((('d_year = 1999) AND ('avg_monthly_sales > 0)) AND (CASE WHEN ('avg_monthly_sales > 0) THEN ('abs(('sum_sales - 'avg_monthly_sales)) / 'avg_monthly_sales) ELSE null END > 0.1))
               +- 'UnresolvedRelation [v2]

== Analyzed Logical Plan ==
i_category: string, d_year: int, d_moy: int, avg_monthly_sales: decimal(21,6), sum_sales: decimal(17,2), psum: decimal(17,2), nsum: decimal(17,2)
GlobalLimit 100
+- LocalLimit 100
   +- Sort [CheckOverflow((promote_precision(cast(sum_sales#1 as decimal(22,6))) - promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(22,6), true) ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST], true
      +- Project [i_category#7, d_year#8, d_moy#6, avg_monthly_sales#2, sum_sales#1, psum#4, nsum#5]
         +- Filter (((d_year#8 = 1999) AND (cast(avg_monthly_sales#2 as decimal(21,6)) > cast(cast(0 as decimal(1,0)) as decimal(21,6)))) AND (cast(CASE WHEN (cast(avg_monthly_sales#2 as decimal(21,6)) > cast(cast(0 as decimal(1,0)) as decimal(21,6))) THEN CheckOverflow((promote_precision(cast(abs(CheckOverflow((promote_precision(cast(sum_sales#1 as decimal(22,6))) - promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(22,6), true)) as decimal(22,6))) / promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(38,16), true) ELSE cast(null as decimal(38,16)) END as decimal(38,16)) > cast(0.1 as decimal(38,16))))
            +- SubqueryAlias v2
               +- Project [i_category#7, d_year#8, d_moy#6, avg_monthly_sales#2, sum_sales#1, sum_sales#9 AS psum#4, sum_sales#10 AS nsum#5]
                  +- Filter (((((i_category#7 = i_category#11) AND (i_category#7 = i_category#12)) AND (i_brand#13 = i_brand#14)) AND ((i_brand#13 = i_brand#15) AND (s_store_name#16 = s_store_name#17))) AND ((((s_store_name#16 = s_store_name#18) AND (s_company_name#19 = s_company_name#20)) AND (s_company_name#19 = s_company_name#21)) AND ((rn#3 = (rn#22 + 1)) AND (rn#3 = (rn#23 - 1)))))
                     +- Join Inner
                        :- Join Inner
                        :  :- SubqueryAlias v1
                        :  :  +- Project [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum_sales#1, avg_monthly_sales#2, rn#3]
                        :  :     +- Project [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum_sales#1, _w0#24, rn#3, avg_monthly_sales#2, avg_monthly_sales#2, rn#3]
                        :  :        +- Window [avg(_w0#24) windowspecdefinition(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg_monthly_sales#2], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8]
                        :  :           +- Window [rank(d_year#8, d_moy#6) windowspecdefinition(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8 ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#3], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19], [d_year#8 ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST]
                        :  :              +- Aggregate [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum(ss_sales_price#25) AS sum_sales#1, sum(ss_sales_price#25) AS _w0#24]
                        :  :                 +- Filter (((ss_item_sk#26 = i_item_sk#27) AND (ss_sold_date_sk#28 = d_date_sk#29)) AND ((ss_store_sk#30 = s_store_sk#31) AND (((d_year#8 = 1999) OR ((d_year#8 = (1999 - 1)) AND (d_moy#6 = 12))) OR ((d_year#8 = (1999 + 1)) AND (d_moy#6 = 1)))))
                        :  :                    +- Join Inner
                        :  :                       :- Join Inner
                        :  :                       :  :- Join Inner
                        :  :                       :  :  :- SubqueryAlias spark_catalog.default.item
                        :  :                       :  :  :  +- Relation[i_item_sk#27,i_item_id#32,i_rec_start_date#33,i_rec_end_date#34,i_item_desc#35,i_current_price#36,i_wholesale_cost#37,i_brand_id#38,i_brand#13,i_class_id#39,i_class#40,i_category_id#41,i_category#7,i_manufact_id#42,i_manufact#43,i_size#44,i_formulation#45,i_color#46,i_units#47,i_container#48,i_manager_id#49,i_product_name#50] parquet
                        :  :                       :  :  +- SubqueryAlias spark_catalog.default.store_sales
                        :  :                       :  :     +- Relation[ss_sold_date_sk#28,ss_sold_time_sk#51,ss_item_sk#26,ss_customer_sk#52,ss_cdemo_sk#53,ss_hdemo_sk#54,ss_addr_sk#55,ss_store_sk#30,ss_promo_sk#56,ss_ticket_number#57,ss_quantity#58,ss_wholesale_cost#59,ss_list_price#60,ss_sales_price#25,ss_ext_discount_amt#61,ss_ext_sales_price#62,ss_ext_wholesale_cost#63,ss_ext_list_price#64,ss_ext_tax#65,ss_coupon_amt#66,ss_net_paid#67,ss_net_paid_inc_tax#68,ss_net_profit#69] parquet
                        :  :                       :  +- SubqueryAlias spark_catalog.default.date_dim
                        :  :                       :     +- Relation[d_date_sk#29,d_date_id#70,d_date#71,d_month_seq#72,d_week_seq#73,d_quarter_seq#74,d_year#8,d_dow#75,d_moy#6,d_dom#76,d_qoy#77,d_fy_year#78,d_fy_quarter_seq#79,d_fy_week_seq#80,d_day_name#81,d_quarter_name#82,d_holiday#83,d_weekend#84,d_following_holiday#85,d_first_dom#86,d_last_dom#87,d_same_day_ly#88,d_same_day_lq#89,d_current_day#90,d_current_week#91,d_current_month#92,d_current_quarter#93,d_current_year#94] parquet
                        :  :                       +- SubqueryAlias spark_catalog.default.store
                        :  :                          +- Relation[s_store_sk#31,s_store_id#95,s_rec_start_date#96,s_rec_end_date#97,s_closed_date_sk#98,s_store_name#16,s_number_employees#99,s_floor_space#100,s_hours#101,s_manager#102,s_market_id#103,s_geography_class#104,s_market_desc#105,s_market_manager#106,s_division_id#107,s_division_name#108,s_company_id#109,s_company_name#19,s_street_number#110,s_street_name#111,s_street_type#112,s_suite_number#113,s_city#114,s_county#115,s_state#116,s_zip#117,s_country#118,s_gmt_offset#119,s_tax_percentage#120] parquet
                        :  +- SubqueryAlias v1_lag
                        :     +- SubqueryAlias v1
                        :        +- Project [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122, sum_sales#9, avg_monthly_sales#123, rn#22]
                        :           +- Project [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122, sum_sales#9, _w0#124, rn#22, avg_monthly_sales#123, avg_monthly_sales#123, rn#22]
                        :              +- Window [avg(_w0#124) windowspecdefinition(i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg_monthly_sales#123], [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121]
                        :                 +- Window [rank(d_year#121, d_moy#122) windowspecdefinition(i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121 ASC NULLS FIRST, d_moy#122 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#22], [i_category#11, i_brand#14, s_store_name#17, s_company_name#20], [d_year#121 ASC NULLS FIRST, d_moy#122 ASC NULLS FIRST]
                        :                    +- Aggregate [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122], [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122, sum(ss_sales_price#25) AS sum_sales#9, sum(ss_sales_price#25) AS _w0#124]
                        :                       +- Filter (((ss_item_sk#26 = i_item_sk#125) AND (ss_sold_date_sk#28 = d_date_sk#126)) AND ((ss_store_sk#30 = s_store_sk#127) AND (((d_year#121 = 1999) OR ((d_year#121 = (1999 - 1)) AND (d_moy#122 = 12))) OR ((d_year#121 = (1999 + 1)) AND (d_moy#122 = 1)))))
                        :                          +- Join Inner
                        :                             :- Join Inner
                        :                             :  :- Join Inner
                        :                             :  :  :- SubqueryAlias spark_catalog.default.item
                        :                             :  :  :  +- Relation[i_item_sk#125,i_item_id#128,i_rec_start_date#129,i_rec_end_date#130,i_item_desc#131,i_current_price#132,i_wholesale_cost#133,i_brand_id#134,i_brand#14,i_class_id#135,i_class#136,i_category_id#137,i_category#11,i_manufact_id#138,i_manufact#139,i_size#140,i_formulation#141,i_color#142,i_units#143,i_container#144,i_manager_id#145,i_product_name#146] parquet
                        :                             :  :  +- SubqueryAlias spark_catalog.default.store_sales
                        :                             :  :     +- Relation[ss_sold_date_sk#28,ss_sold_time_sk#51,ss_item_sk#26,ss_customer_sk#52,ss_cdemo_sk#53,ss_hdemo_sk#54,ss_addr_sk#55,ss_store_sk#30,ss_promo_sk#56,ss_ticket_number#57,ss_quantity#58,ss_wholesale_cost#59,ss_list_price#60,ss_sales_price#25,ss_ext_discount_amt#61,ss_ext_sales_price#62,ss_ext_wholesale_cost#63,ss_ext_list_price#64,ss_ext_tax#65,ss_coupon_amt#66,ss_net_paid#67,ss_net_paid_inc_tax#68,ss_net_profit#69] parquet
                        :                             :  +- SubqueryAlias spark_catalog.default.date_dim
                        :                             :     +- Relation[d_date_sk#126,d_date_id#147,d_date#148,d_month_seq#149,d_week_seq#150,d_quarter_seq#151,d_year#121,d_dow#152,d_moy#122,d_dom#153,d_qoy#154,d_fy_year#155,d_fy_quarter_seq#156,d_fy_week_seq#157,d_day_name#158,d_quarter_name#159,d_holiday#160,d_weekend#161,d_following_holiday#162,d_first_dom#163,d_last_dom#164,d_same_day_ly#165,d_same_day_lq#166,d_current_day#167,d_current_week#168,d_current_month#169,d_current_quarter#170,d_current_year#171] parquet
                        :                             +- SubqueryAlias spark_catalog.default.store
                        :                                +- Relation[s_store_sk#127,s_store_id#172,s_rec_start_date#173,s_rec_end_date#174,s_closed_date_sk#175,s_store_name#17,s_number_employees#176,s_floor_space#177,s_hours#178,s_manager#179,s_market_id#180,s_geography_class#181,s_market_desc#182,s_market_manager#183,s_division_id#184,s_division_name#185,s_company_id#186,s_company_name#20,s_street_number#187,s_street_name#188,s_street_type#189,s_suite_number#190,s_city#191,s_county#192,s_state#193,s_zip#194,s_country#195,s_gmt_offset#196,s_tax_percentage#197] parquet
                        +- SubqueryAlias v1_lead
                           +- SubqueryAlias v1
                              +- Project [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, d_moy#199, sum_sales#10, avg_monthly_sales#200, rn#23]
                                 +- Project [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, d_moy#199, sum_sales#10, _w0#201, rn#23, avg_monthly_sales#200, avg_monthly_sales#200, rn#23]
                                    +- Window [avg(_w0#201) windowspecdefinition(i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg_monthly_sales#200], [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198]
                                       +- Window [rank(d_year#198, d_moy#199) windowspecdefinition(i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198 ASC NULLS FIRST, d_moy#199 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#23], [i_category#12, i_brand#15, s_store_name#18, s_company_name#21], [d_year#198 ASC NULLS FIRST, d_moy#199 ASC NULLS FIRST]
                                          +- Aggregate [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, d_moy#199], [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, d_moy#199, sum(ss_sales_price#25) AS sum_sales#10, sum(ss_sales_price#25) AS _w0#201]
                                             +- Filter (((ss_item_sk#26 = i_item_sk#202) AND (ss_sold_date_sk#28 = d_date_sk#203)) AND ((ss_store_sk#30 = s_store_sk#204) AND (((d_year#198 = 1999) OR ((d_year#198 = (1999 - 1)) AND (d_moy#199 = 12))) OR ((d_year#198 = (1999 + 1)) AND (d_moy#199 = 1)))))
                                                +- Join Inner
                                                   :- Join Inner
                                                   :  :- Join Inner
                                                   :  :  :- SubqueryAlias spark_catalog.default.item
                                                   :  :  :  +- Relation[i_item_sk#202,i_item_id#205,i_rec_start_date#206,i_rec_end_date#207,i_item_desc#208,i_current_price#209,i_wholesale_cost#210,i_brand_id#211,i_brand#15,i_class_id#212,i_class#213,i_category_id#214,i_category#12,i_manufact_id#215,i_manufact#216,i_size#217,i_formulation#218,i_color#219,i_units#220,i_container#221,i_manager_id#222,i_product_name#223] parquet
                                                   :  :  +- SubqueryAlias spark_catalog.default.store_sales
                                                   :  :     +- Relation[ss_sold_date_sk#28,ss_sold_time_sk#51,ss_item_sk#26,ss_customer_sk#52,ss_cdemo_sk#53,ss_hdemo_sk#54,ss_addr_sk#55,ss_store_sk#30,ss_promo_sk#56,ss_ticket_number#57,ss_quantity#58,ss_wholesale_cost#59,ss_list_price#60,ss_sales_price#25,ss_ext_discount_amt#61,ss_ext_sales_price#62,ss_ext_wholesale_cost#63,ss_ext_list_price#64,ss_ext_tax#65,ss_coupon_amt#66,ss_net_paid#67,ss_net_paid_inc_tax#68,ss_net_profit#69] parquet
                                                   :  +- SubqueryAlias spark_catalog.default.date_dim
                                                   :     +- Relation[d_date_sk#203,d_date_id#224,d_date#225,d_month_seq#226,d_week_seq#227,d_quarter_seq#228,d_year#198,d_dow#229,d_moy#199,d_dom#230,d_qoy#231,d_fy_year#232,d_fy_quarter_seq#233,d_fy_week_seq#234,d_day_name#235,d_quarter_name#236,d_holiday#237,d_weekend#238,d_following_holiday#239,d_first_dom#240,d_last_dom#241,d_same_day_ly#242,d_same_day_lq#243,d_current_day#244,d_current_week#245,d_current_month#246,d_current_quarter#247,d_current_year#248] parquet
                                                   +- SubqueryAlias spark_catalog.default.store
                                                      +- Relation[s_store_sk#204,s_store_id#249,s_rec_start_date#250,s_rec_end_date#251,s_closed_date_sk#252,s_store_name#18,s_number_employees#253,s_floor_space#254,s_hours#255,s_manager#256,s_market_id#257,s_geography_class#258,s_market_desc#259,s_market_manager#260,s_division_id#261,s_division_name#262,s_company_id#263,s_company_name#21,s_street_number#264,s_street_name#265,s_street_type#266,s_suite_number#267,s_city#268,s_county#269,s_state#270,s_zip#271,s_country#272,s_gmt_offset#273,s_tax_percentage#274] parquet

== Optimized Logical Plan ==
GlobalLimit 100
+- LocalLimit 100
   +- Sort [CheckOverflow((promote_precision(cast(sum_sales#1 as decimal(22,6))) - promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(22,6), true) ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST], true
      +- Project [i_category#7, d_year#8, d_moy#6, avg_monthly_sales#2, sum_sales#1, sum_sales#9 AS psum#4, sum_sales#10 AS nsum#5]
         +- Join Inner, (((((i_category#7 = i_category#12) AND (i_brand#13 = i_brand#15)) AND (s_store_name#16 = s_store_name#18)) AND (s_company_name#19 = s_company_name#21)) AND (rn#3 = (rn#23 - 1)))
            :- Project [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum_sales#1, avg_monthly_sales#2, rn#3, sum_sales#9]
            :  +- Join Inner, (((((i_category#7 = i_category#11) AND (i_brand#13 = i_brand#14)) AND (s_store_name#16 = s_store_name#17)) AND (s_company_name#19 = s_company_name#20)) AND (rn#3 = (rn#22 + 1)))
            :     :- Project [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum_sales#1, avg_monthly_sales#2, rn#3]
            :     :  +- Filter (((isnotnull(avg_monthly_sales#2) AND (avg_monthly_sales#2 > 0.000000)) AND (CASE WHEN (avg_monthly_sales#2 > 0.000000) THEN CheckOverflow((promote_precision(abs(CheckOverflow((promote_precision(cast(sum_sales#1 as decimal(22,6))) - promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(22,6), true))) / promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(38,16), true) ELSE null END > 0.1000000000000000)) AND isnotnull(rn#3))
            :     :     +- Window [avg(_w0#24) windowspecdefinition(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg_monthly_sales#2], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8]
            :     :        +- Filter (isnotnull(d_year#8) AND (d_year#8 = 1999))
            :     :           +- Window [rank(d_year#8, d_moy#6) windowspecdefinition(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8 ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#3], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19], [d_year#8 ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST]
            :     :              +- Aggregate [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, MakeDecimal(sum(UnscaledValue(ss_sales_price#25)),17,2) AS sum_sales#1, MakeDecimal(sum(UnscaledValue(ss_sales_price#25)),17,2) AS _w0#24]
            :     :                 +- Project [i_brand#13, i_category#7, ss_sales_price#25, d_year#8, d_moy#6, s_store_name#16, s_company_name#19]
            :     :                    +- Join Inner, (ss_store_sk#30 = s_store_sk#31)
            :     :                       :- Project [i_brand#13, i_category#7, ss_store_sk#30, ss_sales_price#25, d_year#8, d_moy#6]
            :     :                       :  +- Join Inner, (ss_sold_date_sk#28 = d_date_sk#29)
            :     :                       :     :- Project [i_brand#13, i_category#7, ss_sold_date_sk#28, ss_store_sk#30, ss_sales_price#25]
            :     :                       :     :  +- Join Inner, (ss_item_sk#26 = i_item_sk#27)
            :     :                       :     :     :- Project [i_item_sk#27, i_brand#13, i_category#7]
            :     :                       :     :     :  +- Filter ((isnotnull(i_item_sk#27) AND isnotnull(i_category#7)) AND isnotnull(i_brand#13))
            :     :                       :     :     :     +- Relation[i_item_sk#27,i_item_id#32,i_rec_start_date#33,i_rec_end_date#34,i_item_desc#35,i_current_price#36,i_wholesale_cost#37,i_brand_id#38,i_brand#13,i_class_id#39,i_class#40,i_category_id#41,i_category#7,i_manufact_id#42,i_manufact#43,i_size#44,i_formulation#45,i_color#46,i_units#47,i_container#48,i_manager_id#49,i_product_name#50] parquet
            :     :                       :     :     +- Project [ss_sold_date_sk#28, ss_item_sk#26, ss_store_sk#30, ss_sales_price#25]
            :     :                       :     :        +- Filter ((isnotnull(ss_item_sk#26) AND isnotnull(ss_sold_date_sk#28)) AND isnotnull(ss_store_sk#30))
            :     :                       :     :           +- Relation[ss_sold_date_sk#28,ss_sold_time_sk#51,ss_item_sk#26,ss_customer_sk#52,ss_cdemo_sk#53,ss_hdemo_sk#54,ss_addr_sk#55,ss_store_sk#30,ss_promo_sk#56,ss_ticket_number#57,ss_quantity#58,ss_wholesale_cost#59,ss_list_price#60,ss_sales_price#25,ss_ext_discount_amt#61,ss_ext_sales_price#62,ss_ext_wholesale_cost#63,ss_ext_list_price#64,ss_ext_tax#65,ss_coupon_amt#66,ss_net_paid#67,ss_net_paid_inc_tax#68,ss_net_profit#69] parquet
            :     :                       :     +- Project [d_date_sk#29, d_year#8, d_moy#6]
            :     :                       :        +- Filter ((((d_year#8 = 1999) OR ((d_year#8 = 1998) AND (d_moy#6 = 12))) OR ((d_year#8 = 2000) AND (d_moy#6 = 1))) AND isnotnull(d_date_sk#29))
            :     :                       :           +- Relation[d_date_sk#29,d_date_id#70,d_date#71,d_month_seq#72,d_week_seq#73,d_quarter_seq#74,d_year#8,d_dow#75,d_moy#6,d_dom#76,d_qoy#77,d_fy_year#78,d_fy_quarter_seq#79,d_fy_week_seq#80,d_day_name#81,d_quarter_name#82,d_holiday#83,d_weekend#84,d_following_holiday#85,d_first_dom#86,d_last_dom#87,d_same_day_ly#88,d_same_day_lq#89,d_current_day#90,d_current_week#91,d_current_month#92,d_current_quarter#93,d_current_year#94] parquet
            :     :                       +- Project [s_store_sk#31, s_store_name#16, s_company_name#19]
            :     :                          +- Filter ((isnotnull(s_store_sk#31) AND isnotnull(s_company_name#19)) AND isnotnull(s_store_name#16))
            :     :                             +- Relation[s_store_sk#31,s_store_id#95,s_rec_start_date#96,s_rec_end_date#97,s_closed_date_sk#98,s_store_name#16,s_number_employees#99,s_floor_space#100,s_hours#101,s_manager#102,s_market_id#103,s_geography_class#104,s_market_desc#105,s_market_manager#106,s_division_id#107,s_division_name#108,s_company_id#109,s_company_name#19,s_street_number#110,s_street_name#111,s_street_type#112,s_suite_number#113,s_city#114,s_county#115,s_state#116,s_zip#117,s_country#118,s_gmt_offset#119,s_tax_percentage#120] parquet
            :     +- Project [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, sum_sales#9, rn#22]
            :        +- Filter isnotnull(rn#22)
            :           +- Window [rank(d_year#121, d_moy#122) windowspecdefinition(i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121 ASC NULLS FIRST, d_moy#122 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#22], [i_category#11, i_brand#14, s_store_name#17, s_company_name#20], [d_year#121 ASC NULLS FIRST, d_moy#122 ASC NULLS FIRST]
            :              +- Aggregate [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122], [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122, MakeDecimal(sum(UnscaledValue(ss_sales_price#25)),17,2) AS sum_sales#9]
            :                 +- Project [i_brand#14, i_category#11, ss_sales_price#25, d_year#121, d_moy#122, s_store_name#17, s_company_name#20]
            :                    +- Join Inner, (ss_store_sk#30 = s_store_sk#127)
            :                       :- Project [i_brand#14, i_category#11, ss_store_sk#30, ss_sales_price#25, d_year#121, d_moy#122]
            :                       :  +- Join Inner, (ss_sold_date_sk#28 = d_date_sk#126)
            :                       :     :- Project [i_brand#14, i_category#11, ss_sold_date_sk#28, ss_store_sk#30, ss_sales_price#25]
            :                       :     :  +- Join Inner, (ss_item_sk#26 = i_item_sk#125)
            :                       :     :     :- Project [i_item_sk#125, i_brand#14, i_category#11]
            :                       :     :     :  +- Filter ((isnotnull(i_item_sk#125) AND isnotnull(i_category#11)) AND isnotnull(i_brand#14))
            :                       :     :     :     +- Relation[i_item_sk#125,i_item_id#128,i_rec_start_date#129,i_rec_end_date#130,i_item_desc#131,i_current_price#132,i_wholesale_cost#133,i_brand_id#134,i_brand#14,i_class_id#135,i_class#136,i_category_id#137,i_category#11,i_manufact_id#138,i_manufact#139,i_size#140,i_formulation#141,i_color#142,i_units#143,i_container#144,i_manager_id#145,i_product_name#146] parquet
            :                       :     :     +- Project [ss_sold_date_sk#28, ss_item_sk#26, ss_store_sk#30, ss_sales_price#25]
            :                       :     :        +- Filter ((isnotnull(ss_item_sk#26) AND isnotnull(ss_sold_date_sk#28)) AND isnotnull(ss_store_sk#30))
            :                       :     :           +- Relation[ss_sold_date_sk#28,ss_sold_time_sk#51,ss_item_sk#26,ss_customer_sk#52,ss_cdemo_sk#53,ss_hdemo_sk#54,ss_addr_sk#55,ss_store_sk#30,ss_promo_sk#56,ss_ticket_number#57,ss_quantity#58,ss_wholesale_cost#59,ss_list_price#60,ss_sales_price#25,ss_ext_discount_amt#61,ss_ext_sales_price#62,ss_ext_wholesale_cost#63,ss_ext_list_price#64,ss_ext_tax#65,ss_coupon_amt#66,ss_net_paid#67,ss_net_paid_inc_tax#68,ss_net_profit#69] parquet
            :                       :     +- Project [d_date_sk#126, d_year#121, d_moy#122]
            :                       :        +- Filter ((((d_year#121 = 1999) OR ((d_year#121 = 1998) AND (d_moy#122 = 12))) OR ((d_year#121 = 2000) AND (d_moy#122 = 1))) AND isnotnull(d_date_sk#126))
            :                       :           +- Relation[d_date_sk#126,d_date_id#147,d_date#148,d_month_seq#149,d_week_seq#150,d_quarter_seq#151,d_year#121,d_dow#152,d_moy#122,d_dom#153,d_qoy#154,d_fy_year#155,d_fy_quarter_seq#156,d_fy_week_seq#157,d_day_name#158,d_quarter_name#159,d_holiday#160,d_weekend#161,d_following_holiday#162,d_first_dom#163,d_last_dom#164,d_same_day_ly#165,d_same_day_lq#166,d_current_day#167,d_current_week#168,d_current_month#169,d_current_quarter#170,d_current_year#171] parquet
            :                       +- Project [s_store_sk#127, s_store_name#17, s_company_name#20]
            :                          +- Filter ((isnotnull(s_store_sk#127) AND isnotnull(s_store_name#17)) AND isnotnull(s_company_name#20))
            :                             +- Relation[s_store_sk#127,s_store_id#172,s_rec_start_date#173,s_rec_end_date#174,s_closed_date_sk#175,s_store_name#17,s_number_employees#176,s_floor_space#177,s_hours#178,s_manager#179,s_market_id#180,s_geography_class#181,s_market_desc#182,s_market_manager#183,s_division_id#184,s_division_name#185,s_company_id#186,s_company_name#20,s_street_number#187,s_street_name#188,s_street_type#189,s_suite_number#190,s_city#191,s_county#192,s_state#193,s_zip#194,s_country#195,s_gmt_offset#196,s_tax_percentage#197] parquet
            +- Project [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, sum_sales#10, rn#23]
               +- Filter isnotnull(rn#23)
                  +- Window [rank(d_year#198, d_moy#199) windowspecdefinition(i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198 ASC NULLS FIRST, d_moy#199 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#23], [i_category#12, i_brand#15, s_store_name#18, s_company_name#21], [d_year#198 ASC NULLS FIRST, d_moy#199 ASC NULLS FIRST]
                     +- Aggregate [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, d_moy#199], [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, d_moy#199, MakeDecimal(sum(UnscaledValue(ss_sales_price#25)),17,2) AS sum_sales#10]
                        +- Project [i_brand#15, i_category#12, ss_sales_price#25, d_year#198, d_moy#199, s_store_name#18, s_company_name#21]
                           +- Join Inner, (ss_store_sk#30 = s_store_sk#204)
                              :- Project [i_brand#15, i_category#12, ss_store_sk#30, ss_sales_price#25, d_year#198, d_moy#199]
                              :  +- Join Inner, (ss_sold_date_sk#28 = d_date_sk#203)
                              :     :- Project [i_brand#15, i_category#12, ss_sold_date_sk#28, ss_store_sk#30, ss_sales_price#25]
                              :     :  +- Join Inner, (ss_item_sk#26 = i_item_sk#202)
                              :     :     :- Project [i_item_sk#202, i_brand#15, i_category#12]
                              :     :     :  +- Filter ((isnotnull(i_item_sk#202) AND isnotnull(i_category#12)) AND isnotnull(i_brand#15))
                              :     :     :     +- Relation[i_item_sk#202,i_item_id#205,i_rec_start_date#206,i_rec_end_date#207,i_item_desc#208,i_current_price#209,i_wholesale_cost#210,i_brand_id#211,i_brand#15,i_class_id#212,i_class#213,i_category_id#214,i_category#12,i_manufact_id#215,i_manufact#216,i_size#217,i_formulation#218,i_color#219,i_units#220,i_container#221,i_manager_id#222,i_product_name#223] parquet
                              :     :     +- Project [ss_sold_date_sk#28, ss_item_sk#26, ss_store_sk#30, ss_sales_price#25]
                              :     :        +- Filter ((isnotnull(ss_item_sk#26) AND isnotnull(ss_sold_date_sk#28)) AND isnotnull(ss_store_sk#30))
                              :     :           +- Relation[ss_sold_date_sk#28,ss_sold_time_sk#51,ss_item_sk#26,ss_customer_sk#52,ss_cdemo_sk#53,ss_hdemo_sk#54,ss_addr_sk#55,ss_store_sk#30,ss_promo_sk#56,ss_ticket_number#57,ss_quantity#58,ss_wholesale_cost#59,ss_list_price#60,ss_sales_price#25,ss_ext_discount_amt#61,ss_ext_sales_price#62,ss_ext_wholesale_cost#63,ss_ext_list_price#64,ss_ext_tax#65,ss_coupon_amt#66,ss_net_paid#67,ss_net_paid_inc_tax#68,ss_net_profit#69] parquet
                              :     +- Project [d_date_sk#203, d_year#198, d_moy#199]
                              :        +- Filter ((((d_year#198 = 1999) OR ((d_year#198 = 1998) AND (d_moy#199 = 12))) OR ((d_year#198 = 2000) AND (d_moy#199 = 1))) AND isnotnull(d_date_sk#203))
                              :           +- Relation[d_date_sk#203,d_date_id#224,d_date#225,d_month_seq#226,d_week_seq#227,d_quarter_seq#228,d_year#198,d_dow#229,d_moy#199,d_dom#230,d_qoy#231,d_fy_year#232,d_fy_quarter_seq#233,d_fy_week_seq#234,d_day_name#235,d_quarter_name#236,d_holiday#237,d_weekend#238,d_following_holiday#239,d_first_dom#240,d_last_dom#241,d_same_day_ly#242,d_same_day_lq#243,d_current_day#244,d_current_week#245,d_current_month#246,d_current_quarter#247,d_current_year#248] parquet
                              +- Project [s_store_sk#204, s_store_name#18, s_company_name#21]
                                 +- Filter ((isnotnull(s_store_sk#204) AND isnotnull(s_company_name#21)) AND isnotnull(s_store_name#18))
                                    +- Relation[s_store_sk#204,s_store_id#249,s_rec_start_date#250,s_rec_end_date#251,s_closed_date_sk#252,s_store_name#18,s_number_employees#253,s_floor_space#254,s_hours#255,s_manager#256,s_market_id#257,s_geography_class#258,s_market_desc#259,s_market_manager#260,s_division_id#261,s_division_name#262,s_company_id#263,s_company_name#21,s_street_number#264,s_street_name#265,s_street_type#266,s_suite_number#267,s_city#268,s_county#269,s_state#270,s_zip#271,s_country#272,s_gmt_offset#273,s_tax_percentage#274] parquet

== Physical Plan ==
TakeOrderedAndProject(limit=100, orderBy=[CheckOverflow((promote_precision(cast(sum_sales#1 as decimal(22,6))) - promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(22,6), true) ASC NULLS FIRST,d_moy#6 ASC NULLS FIRST], output=[i_category#7,d_year#8,d_moy#6,avg_monthly_sales#2,sum_sales#1,psum#4,nsum#5])
+- *(22) Project [i_category#7, d_year#8, d_moy#6, avg_monthly_sales#2, sum_sales#1, sum_sales#9 AS psum#4, sum_sales#10 AS nsum#5]
   +- *(22) BroadcastHashJoin [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, rn#3], [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, (rn#23 - 1)], Inner, BuildRight
      :- *(22) Project [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum_sales#1, avg_monthly_sales#2, rn#3, sum_sales#9]
      :  +- *(22) BroadcastHashJoin [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, rn#3], [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, (rn#22 + 1)], Inner, BuildRight
      :     :- *(22) Project [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum_sales#1, avg_monthly_sales#2, rn#3]
      :     :  +- *(22) Filter (((isnotnull(avg_monthly_sales#2) AND (avg_monthly_sales#2 > 0.000000)) AND (CASE WHEN (avg_monthly_sales#2 > 0.000000) THEN CheckOverflow((promote_precision(abs(CheckOverflow((promote_precision(cast(sum_sales#1 as decimal(22,6))) - promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(22,6), true))) / promote_precision(cast(avg_monthly_sales#2 as decimal(22,6)))), DecimalType(38,16), true) ELSE null END > 0.1000000000000000)) AND isnotnull(rn#3))
      :     :     +- Window [avg(_w0#24) windowspecdefinition(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg_monthly_sales#2], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8]
      :     :        +- *(7) Filter (isnotnull(d_year#8) AND (d_year#8 = 1999))
      :     :           +- Window [rank(d_year#8, d_moy#6) windowspecdefinition(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8 ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#3], [i_category#7, i_brand#13, s_store_name#16, s_company_name#19], [d_year#8 ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST]
      :     :              +- *(6) Sort [i_category#7 ASC NULLS FIRST, i_brand#13 ASC NULLS FIRST, s_store_name#16 ASC NULLS FIRST, s_company_name#19 ASC NULLS FIRST, d_year#8 ASC NULLS FIRST, d_moy#6 ASC NULLS FIRST], false, 0
      :     :                 +- Exchange hashpartitioning(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, 5), true, [id=#275]
      :     :                    +- *(5) HashAggregate(keys=[i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6], functions=[sum(UnscaledValue(ss_sales_price#25))], output=[i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum_sales#1, _w0#24])
      :     :                       +- Exchange hashpartitioning(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, 5), true, [id=#276]
      :     :                          +- *(4) HashAggregate(keys=[i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6], functions=[partial_sum(UnscaledValue(ss_sales_price#25))], output=[i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, sum#277])
      :     :                             +- *(4) Project [i_brand#13, i_category#7, ss_sales_price#25, d_year#8, d_moy#6, s_store_name#16, s_company_name#19]
      :     :                                +- *(4) BroadcastHashJoin [ss_store_sk#30], [s_store_sk#31], Inner, BuildRight
      :     :                                   :- *(4) Project [i_brand#13, i_category#7, ss_store_sk#30, ss_sales_price#25, d_year#8, d_moy#6]
      :     :                                   :  +- *(4) BroadcastHashJoin [ss_sold_date_sk#28], [d_date_sk#29], Inner, BuildRight
      :     :                                   :     :- *(4) Project [i_brand#13, i_category#7, ss_sold_date_sk#28, ss_store_sk#30, ss_sales_price#25]
      :     :                                   :     :  +- *(4) BroadcastHashJoin [i_item_sk#27], [ss_item_sk#26], Inner, BuildRight
      :     :                                   :     :     :- *(4) Project [i_item_sk#27, i_brand#13, i_category#7]
      :     :                                   :     :     :  +- *(4) Filter ((isnotnull(i_item_sk#27) AND isnotnull(i_category#7)) AND isnotnull(i_brand#13))
      :     :                                   :     :     :     +- *(4) ColumnarToRow
      :     :                                   :     :     :        +- FileScan parquet default.item[i_item_sk#27,i_brand#13,i_category#7] Batched: true, DataFilters: [isnotnull(i_item_sk#27), isnotnull(i_category#7), isnotnull(i_brand#13)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(i_item_sk), IsNotNull(i_category), IsNotNull(i_brand)], ReadSchema: struct<i_item_sk:int,i_brand:string,i_category:string>
      :     :                                   :     :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[1, int, true] as bigint))), [id=#278]
      :     :                                   :     :        +- *(1) Project [ss_sold_date_sk#28, ss_item_sk#26, ss_store_sk#30, ss_sales_price#25]
      :     :                                   :     :           +- *(1) Filter ((isnotnull(ss_item_sk#26) AND isnotnull(ss_sold_date_sk#28)) AND isnotnull(ss_store_sk#30))
      :     :                                   :     :              +- *(1) ColumnarToRow
      :     :                                   :     :                 +- FileScan parquet default.store_sales[ss_sold_date_sk#28,ss_item_sk#26,ss_store_sk#30,ss_sales_price#25] Batched: true, DataFilters: [isnotnull(ss_item_sk#26), isnotnull(ss_sold_date_sk#28), isnotnull(ss_store_sk#30)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ss_item_sk), IsNotNull(ss_sold_date_sk), IsNotNull(ss_store_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_item_sk:int,ss_store_sk:int,ss_sales_price:decimal(7,2)>
      :     :                                   :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint))), [id=#279]
      :     :                                   :        +- *(2) Project [d_date_sk#29, d_year#8, d_moy#6]
      :     :                                   :           +- *(2) Filter ((((d_year#8 = 1999) OR ((d_year#8 = 1998) AND (d_moy#6 = 12))) OR ((d_year#8 = 2000) AND (d_moy#6 = 1))) AND isnotnull(d_date_sk#29))
      :     :                                   :              +- *(2) ColumnarToRow
      :     :                                   :                 +- FileScan parquet default.date_dim[d_date_sk#29,d_year#8,d_moy#6] Batched: true, DataFilters: [(((d_year#8 = 1999) OR ((d_year#8 = 1998) AND (d_moy#6 = 12))) OR ((d_year#8 = 2000)..., Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [Or(Or(EqualTo(d_year,1999),And(EqualTo(d_year,1998),EqualTo(d_moy,12))),And(EqualTo(d_year,2000)..., ReadSchema: struct<d_date_sk:int,d_year:int,d_moy:int>
      :     :                                   +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint))), [id=#280]
      :     :                                      +- *(3) Project [s_store_sk#31, s_store_name#16, s_company_name#19]
      :     :                                         +- *(3) Filter ((isnotnull(s_store_sk#31) AND isnotnull(s_company_name#19)) AND isnotnull(s_store_name#16))
      :     :                                            +- *(3) ColumnarToRow
      :     :                                               +- FileScan parquet default.store[s_store_sk#31,s_store_name#16,s_company_name#19] Batched: true, DataFilters: [isnotnull(s_store_sk#31), isnotnull(s_company_name#19), isnotnull(s_store_name#16)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk), IsNotNull(s_company_name), IsNotNull(s_store_name)], ReadSchema: struct<s_store_sk:int,s_store_name:string,s_company_name:string>
      :     +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true], input[1, string, true], input[2, string, true], input[3, string, true], (input[5, int, true] + 1))), [id=#281]
      :        +- *(14) Project [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, sum_sales#9, rn#22]
      :           +- *(14) Filter isnotnull(rn#22)
      :              +- Window [rank(d_year#121, d_moy#122) windowspecdefinition(i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121 ASC NULLS FIRST, d_moy#122 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#22], [i_category#11, i_brand#14, s_store_name#17, s_company_name#20], [d_year#121 ASC NULLS FIRST, d_moy#122 ASC NULLS FIRST]
      :                 +- *(13) Sort [i_category#11 ASC NULLS FIRST, i_brand#14 ASC NULLS FIRST, s_store_name#17 ASC NULLS FIRST, s_company_name#20 ASC NULLS FIRST, d_year#121 ASC NULLS FIRST, d_moy#122 ASC NULLS FIRST], false, 0
      :                    +- Exchange hashpartitioning(i_category#11, i_brand#14, s_store_name#17, s_company_name#20, 5), true, [id=#282]
      :                       +- *(12) HashAggregate(keys=[i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122], functions=[sum(UnscaledValue(ss_sales_price#25))], output=[i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122, sum_sales#9])
      :                          +- ReusedExchange [i_category#11, i_brand#14, s_store_name#17, s_company_name#20, d_year#121, d_moy#122, sum#283], Exchange hashpartitioning(i_category#7, i_brand#13, s_store_name#16, s_company_name#19, d_year#8, d_moy#6, 5), true, [id=#276]
      +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true], input[1, string, true], input[2, string, true], input[3, string, true], (input[5, int, true] - 1))), [id=#284]
         +- *(21) Project [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, sum_sales#10, rn#23]
            +- *(21) Filter isnotnull(rn#23)
               +- Window [rank(d_year#198, d_moy#199) windowspecdefinition(i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198 ASC NULLS FIRST, d_moy#199 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#23], [i_category#12, i_brand#15, s_store_name#18, s_company_name#21], [d_year#198 ASC NULLS FIRST, d_moy#199 ASC NULLS FIRST]
                  +- *(20) Sort [i_category#12 ASC NULLS FIRST, i_brand#15 ASC NULLS FIRST, s_store_name#18 ASC NULLS FIRST, s_company_name#21 ASC NULLS FIRST, d_year#198 ASC NULLS FIRST, d_moy#199 ASC NULLS FIRST], false, 0
                     +- ReusedExchange [i_category#12, i_brand#15, s_store_name#18, s_company_name#21, d_year#198, d_moy#199, sum_sales#10], Exchange hashpartitioning(i_category#11, i_brand#14, s_store_name#17, s_company_name#20, 5), true, [id=#282]
