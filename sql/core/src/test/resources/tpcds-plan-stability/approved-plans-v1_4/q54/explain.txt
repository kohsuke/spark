== Parsed Logical Plan ==
CTE [my_customers, my_revenue, segments]
:  :- 'SubqueryAlias my_customers
:  :  +- 'Distinct
:  :     +- 'Project ['c_customer_sk, 'c_current_addr_sk]
:  :        +- 'Filter (((('sold_date_sk = 'd_date_sk) AND ('item_sk = 'i_item_sk)) AND (('i_category = Women) AND ('i_class = maternity))) AND ((('c_customer_sk = 'cs_or_ws_sales.customer_sk) AND ('d_moy = 12)) AND ('d_year = 1998)))
:  :           +- 'Join Inner
:  :              :- 'Join Inner
:  :              :  :- 'Join Inner
:  :              :  :  :- 'SubqueryAlias cs_or_ws_sales
:  :              :  :  :  +- 'Union false, false
:  :              :  :  :     :- 'Project ['cs_sold_date_sk AS sold_date_sk#1, 'cs_bill_customer_sk AS customer_sk#2, 'cs_item_sk AS item_sk#3]
:  :              :  :  :     :  +- 'UnresolvedRelation [catalog_sales]
:  :              :  :  :     +- 'Project ['ws_sold_date_sk AS sold_date_sk#4, 'ws_bill_customer_sk AS customer_sk#5, 'ws_item_sk AS item_sk#6]
:  :              :  :  :        +- 'UnresolvedRelation [web_sales]
:  :              :  :  +- 'UnresolvedRelation [item]
:  :              :  +- 'UnresolvedRelation [date_dim]
:  :              +- 'UnresolvedRelation [customer]
:  :- 'SubqueryAlias my_revenue
:  :  +- 'Aggregate ['c_customer_sk], ['c_customer_sk, 'sum('ss_ext_sales_price) AS revenue#7]
:  :     +- 'Filter (((('c_current_addr_sk = 'ca_address_sk) AND ('ca_county = 's_county)) AND ('ca_state = 's_state)) AND ((('ss_sold_date_sk = 'd_date_sk) AND ('c_customer_sk = 'ss_customer_sk)) AND (('d_month_seq >= scalar-subquery#8 []) AND ('d_month_seq <= scalar-subquery#9 []))))
:  :        :  :- 'Distinct
:  :        :  :  +- 'Project [unresolvedalias(('d_month_seq + 1), None)]
:  :        :  :     +- 'Filter (('d_year = 1998) AND ('d_moy = 12))
:  :        :  :        +- 'UnresolvedRelation [date_dim]
:  :        :  +- 'Distinct
:  :        :     +- 'Project [unresolvedalias(('d_month_seq + 3), None)]
:  :        :        +- 'Filter (('d_year = 1998) AND ('d_moy = 12))
:  :        :           +- 'UnresolvedRelation [date_dim]
:  :        +- 'Join Inner
:  :           :- 'Join Inner
:  :           :  :- 'Join Inner
:  :           :  :  :- 'Join Inner
:  :           :  :  :  :- 'UnresolvedRelation [my_customers]
:  :           :  :  :  +- 'UnresolvedRelation [store_sales]
:  :           :  :  +- 'UnresolvedRelation [customer_address]
:  :           :  +- 'UnresolvedRelation [store]
:  :           +- 'UnresolvedRelation [date_dim]
:  +- 'SubqueryAlias segments
:     +- 'Project [cast(('revenue / 50) as int) AS segment#10]
:        +- 'UnresolvedRelation [my_revenue]
+- 'GlobalLimit 100
   +- 'LocalLimit 100
      +- 'Sort ['segment ASC NULLS FIRST, 'num_customers ASC NULLS FIRST], true
         +- 'Aggregate ['segment], ['segment, 'count(1) AS num_customers#11, ('segment * 50) AS segment_base#12]
            +- 'UnresolvedRelation [segments]

== Analyzed Logical Plan ==
segment: int, num_customers: bigint, segment_base: int
GlobalLimit 100
+- LocalLimit 100
   +- Sort [segment#10 ASC NULLS FIRST, num_customers#13 ASC NULLS FIRST], true
      +- Aggregate [segment#10], [segment#10, count(1) AS num_customers#13, (segment#10 * 50) AS segment_base#12]
         +- SubqueryAlias segments
            +- Project [cast(CheckOverflow((promote_precision(cast(revenue#7 as decimal(17,2))) / promote_precision(cast(cast(50 as decimal(2,0)) as decimal(17,2)))), DecimalType(21,6), true) as int) AS segment#10]
               +- SubqueryAlias my_revenue
                  +- Aggregate [c_customer_sk#14], [c_customer_sk#14, sum(ss_ext_sales_price#15) AS revenue#7]
                     +- Filter ((((c_current_addr_sk#16 = ca_address_sk#17) AND (ca_county#18 = s_county#19)) AND (ca_state#20 = s_state#21)) AND (((ss_sold_date_sk#22 = d_date_sk#23) AND (c_customer_sk#14 = ss_customer_sk#24)) AND ((d_month_seq#25 >= scalar-subquery#8 []) AND (d_month_seq#25 <= scalar-subquery#9 []))))
                        :  :- Distinct
                        :  :  +- Project [(d_month_seq#25 + 1) AS (d_month_seq + 1)#26]
                        :  :     +- Filter ((d_year#27 = 1998) AND (d_moy#28 = 12))
                        :  :        +- SubqueryAlias spark_catalog.default.date_dim
                        :  :           +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet
                        :  +- Distinct
                        :     +- Project [(d_month_seq#25 + 3) AS (d_month_seq + 3)#49]
                        :        +- Filter ((d_year#27 = 1998) AND (d_moy#28 = 12))
                        :           +- SubqueryAlias spark_catalog.default.date_dim
                        :              +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet
                        +- Join Inner
                           :- Join Inner
                           :  :- Join Inner
                           :  :  :- Join Inner
                           :  :  :  :- SubqueryAlias my_customers
                           :  :  :  :  +- Distinct
                           :  :  :  :     +- Project [c_customer_sk#14, c_current_addr_sk#16]
                           :  :  :  :        +- Filter ((((sold_date_sk#1 = d_date_sk#23) AND (item_sk#3 = i_item_sk#50)) AND ((i_category#51 = Women) AND (i_class#52 = maternity))) AND (((c_customer_sk#14 = customer_sk#2) AND (d_moy#28 = 12)) AND (d_year#27 = 1998)))
                           :  :  :  :           +- Join Inner
                           :  :  :  :              :- Join Inner
                           :  :  :  :              :  :- Join Inner
                           :  :  :  :              :  :  :- SubqueryAlias cs_or_ws_sales
                           :  :  :  :              :  :  :  +- Union false, false
                           :  :  :  :              :  :  :     :- Project [cs_sold_date_sk#53 AS sold_date_sk#1, cs_bill_customer_sk#54 AS customer_sk#2, cs_item_sk#55 AS item_sk#3]
                           :  :  :  :              :  :  :     :  +- SubqueryAlias spark_catalog.default.catalog_sales
                           :  :  :  :              :  :  :     :     +- Relation[cs_sold_date_sk#53,cs_sold_time_sk#56,cs_ship_date_sk#57,cs_bill_customer_sk#54,cs_bill_cdemo_sk#58,cs_bill_hdemo_sk#59,cs_bill_addr_sk#60,cs_ship_customer_sk#61,cs_ship_cdemo_sk#62,cs_ship_hdemo_sk#63,cs_ship_addr_sk#64,cs_call_center_sk#65,cs_catalog_page_sk#66,cs_ship_mode_sk#67,cs_warehouse_sk#68,cs_item_sk#55,cs_promo_sk#69,cs_order_number#70,cs_quantity#71,cs_wholesale_cost#72,cs_list_price#73,cs_sales_price#74,cs_ext_discount_amt#75,cs_ext_sales_price#76,... 10 more fields] parquet
                           :  :  :  :              :  :  :     +- Project [ws_sold_date_sk#77 AS sold_date_sk#4, ws_bill_customer_sk#78 AS customer_sk#5, ws_item_sk#79 AS item_sk#6]
                           :  :  :  :              :  :  :        +- SubqueryAlias spark_catalog.default.web_sales
                           :  :  :  :              :  :  :           +- Relation[ws_sold_date_sk#77,ws_sold_time_sk#80,ws_ship_date_sk#81,ws_item_sk#79,ws_bill_customer_sk#78,ws_bill_cdemo_sk#82,ws_bill_hdemo_sk#83,ws_bill_addr_sk#84,ws_ship_customer_sk#85,ws_ship_cdemo_sk#86,ws_ship_hdemo_sk#87,ws_ship_addr_sk#88,ws_web_page_sk#89,ws_web_site_sk#90,ws_ship_mode_sk#91,ws_warehouse_sk#92,ws_promo_sk#93,ws_order_number#94,ws_quantity#95,ws_wholesale_cost#96,ws_list_price#97,ws_sales_price#98,ws_ext_discount_amt#99,ws_ext_sales_price#100,... 10 more fields] parquet
                           :  :  :  :              :  :  +- SubqueryAlias spark_catalog.default.item
                           :  :  :  :              :  :     +- Relation[i_item_sk#50,i_item_id#101,i_rec_start_date#102,i_rec_end_date#103,i_item_desc#104,i_current_price#105,i_wholesale_cost#106,i_brand_id#107,i_brand#108,i_class_id#109,i_class#52,i_category_id#110,i_category#51,i_manufact_id#111,i_manufact#112,i_size#113,i_formulation#114,i_color#115,i_units#116,i_container#117,i_manager_id#118,i_product_name#119] parquet
                           :  :  :  :              :  +- SubqueryAlias spark_catalog.default.date_dim
                           :  :  :  :              :     +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet
                           :  :  :  :              +- SubqueryAlias spark_catalog.default.customer
                           :  :  :  :                 +- Relation[c_customer_sk#14,c_customer_id#120,c_current_cdemo_sk#121,c_current_hdemo_sk#122,c_current_addr_sk#16,c_first_shipto_date_sk#123,c_first_sales_date_sk#124,c_salutation#125,c_first_name#126,c_last_name#127,c_preferred_cust_flag#128,c_birth_day#129,c_birth_month#130,c_birth_year#131,c_birth_country#132,c_login#133,c_email_address#134,c_last_review_date#135] parquet
                           :  :  :  +- SubqueryAlias spark_catalog.default.store_sales
                           :  :  :     +- Relation[ss_sold_date_sk#22,ss_sold_time_sk#136,ss_item_sk#137,ss_customer_sk#24,ss_cdemo_sk#138,ss_hdemo_sk#139,ss_addr_sk#140,ss_store_sk#141,ss_promo_sk#142,ss_ticket_number#143,ss_quantity#144,ss_wholesale_cost#145,ss_list_price#146,ss_sales_price#147,ss_ext_discount_amt#148,ss_ext_sales_price#15,ss_ext_wholesale_cost#149,ss_ext_list_price#150,ss_ext_tax#151,ss_coupon_amt#152,ss_net_paid#153,ss_net_paid_inc_tax#154,ss_net_profit#155] parquet
                           :  :  +- SubqueryAlias spark_catalog.default.customer_address
                           :  :     +- Relation[ca_address_sk#17,ca_address_id#156,ca_street_number#157,ca_street_name#158,ca_street_type#159,ca_suite_number#160,ca_city#161,ca_county#18,ca_state#20,ca_zip#162,ca_country#163,ca_gmt_offset#164,ca_location_type#165] parquet
                           :  +- SubqueryAlias spark_catalog.default.store
                           :     +- Relation[s_store_sk#166,s_store_id#167,s_rec_start_date#168,s_rec_end_date#169,s_closed_date_sk#170,s_store_name#171,s_number_employees#172,s_floor_space#173,s_hours#174,s_manager#175,s_market_id#176,s_geography_class#177,s_market_desc#178,s_market_manager#179,s_division_id#180,s_division_name#181,s_company_id#182,s_company_name#183,s_street_number#184,s_street_name#185,s_street_type#186,s_suite_number#187,s_city#188,s_county#19,... 5 more fields] parquet
                           +- SubqueryAlias spark_catalog.default.date_dim
                              +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet

== Optimized Logical Plan ==
GlobalLimit 100
+- LocalLimit 100
   +- Sort [segment#10 ASC NULLS FIRST, num_customers#13 ASC NULLS FIRST], true
      +- Aggregate [segment#10], [segment#10, count(1) AS num_customers#13, (segment#10 * 50) AS segment_base#12]
         +- Aggregate [c_customer_sk#14], [cast(CheckOverflow((promote_precision(MakeDecimal(sum(UnscaledValue(ss_ext_sales_price#15)),17,2)) / 50.00), DecimalType(21,6), true) as int) AS segment#10]
            +- Project [c_customer_sk#14, ss_ext_sales_price#15]
               +- Join Inner, (ss_sold_date_sk#22 = d_date_sk#23)
                  :- Project [c_customer_sk#14, ss_sold_date_sk#22, ss_ext_sales_price#15]
                  :  +- Join Inner, ((ca_county#18 = s_county#19) AND (ca_state#20 = s_state#21))
                  :     :- Project [c_customer_sk#14, ss_sold_date_sk#22, ss_ext_sales_price#15, ca_county#18, ca_state#20]
                  :     :  +- Join Inner, (c_current_addr_sk#16 = ca_address_sk#17)
                  :     :     :- Project [c_customer_sk#14, c_current_addr_sk#16, ss_sold_date_sk#22, ss_ext_sales_price#15]
                  :     :     :  +- Join Inner, (c_customer_sk#14 = ss_customer_sk#24)
                  :     :     :     :- Aggregate [c_customer_sk#14, c_current_addr_sk#16], [c_customer_sk#14, c_current_addr_sk#16]
                  :     :     :     :  +- Project [c_customer_sk#14, c_current_addr_sk#16]
                  :     :     :     :     +- Join Inner, (c_customer_sk#14 = customer_sk#2)
                  :     :     :     :        :- Project [customer_sk#2]
                  :     :     :     :        :  +- Join Inner, (sold_date_sk#1 = d_date_sk#23)
                  :     :     :     :        :     :- Project [sold_date_sk#1, customer_sk#2]
                  :     :     :     :        :     :  +- Join Inner, (item_sk#3 = i_item_sk#50)
                  :     :     :     :        :     :     :- Union false, false
                  :     :     :     :        :     :     :  :- Project [cs_sold_date_sk#53 AS sold_date_sk#1, cs_bill_customer_sk#54 AS customer_sk#2, cs_item_sk#55 AS item_sk#3]
                  :     :     :     :        :     :     :  :  +- Filter ((isnotnull(cs_item_sk#55) AND isnotnull(cs_sold_date_sk#53)) AND isnotnull(cs_bill_customer_sk#54))
                  :     :     :     :        :     :     :  :     +- Relation[cs_sold_date_sk#53,cs_sold_time_sk#56,cs_ship_date_sk#57,cs_bill_customer_sk#54,cs_bill_cdemo_sk#58,cs_bill_hdemo_sk#59,cs_bill_addr_sk#60,cs_ship_customer_sk#61,cs_ship_cdemo_sk#62,cs_ship_hdemo_sk#63,cs_ship_addr_sk#64,cs_call_center_sk#65,cs_catalog_page_sk#66,cs_ship_mode_sk#67,cs_warehouse_sk#68,cs_item_sk#55,cs_promo_sk#69,cs_order_number#70,cs_quantity#71,cs_wholesale_cost#72,cs_list_price#73,cs_sales_price#74,cs_ext_discount_amt#75,cs_ext_sales_price#76,... 10 more fields] parquet
                  :     :     :     :        :     :     :  +- Project [ws_sold_date_sk#77 AS sold_date_sk#4, ws_bill_customer_sk#78 AS customer_sk#5, ws_item_sk#79 AS item_sk#6]
                  :     :     :     :        :     :     :     +- Filter ((isnotnull(ws_item_sk#79) AND isnotnull(ws_sold_date_sk#77)) AND isnotnull(ws_bill_customer_sk#78))
                  :     :     :     :        :     :     :        +- Relation[ws_sold_date_sk#77,ws_sold_time_sk#80,ws_ship_date_sk#81,ws_item_sk#79,ws_bill_customer_sk#78,ws_bill_cdemo_sk#82,ws_bill_hdemo_sk#83,ws_bill_addr_sk#84,ws_ship_customer_sk#85,ws_ship_cdemo_sk#86,ws_ship_hdemo_sk#87,ws_ship_addr_sk#88,ws_web_page_sk#89,ws_web_site_sk#90,ws_ship_mode_sk#91,ws_warehouse_sk#92,ws_promo_sk#93,ws_order_number#94,ws_quantity#95,ws_wholesale_cost#96,ws_list_price#97,ws_sales_price#98,ws_ext_discount_amt#99,ws_ext_sales_price#100,... 10 more fields] parquet
                  :     :     :     :        :     :     +- Project [i_item_sk#50]
                  :     :     :     :        :     :        +- Filter ((((isnotnull(i_category#51) AND isnotnull(i_class#52)) AND (i_category#51 = Women)) AND (i_class#52 = maternity)) AND isnotnull(i_item_sk#50))
                  :     :     :     :        :     :           +- Relation[i_item_sk#50,i_item_id#101,i_rec_start_date#102,i_rec_end_date#103,i_item_desc#104,i_current_price#105,i_wholesale_cost#106,i_brand_id#107,i_brand#108,i_class_id#109,i_class#52,i_category_id#110,i_category#51,i_manufact_id#111,i_manufact#112,i_size#113,i_formulation#114,i_color#115,i_units#116,i_container#117,i_manager_id#118,i_product_name#119] parquet
                  :     :     :     :        :     +- Project [d_date_sk#23]
                  :     :     :     :        :        +- Filter ((((isnotnull(d_moy#28) AND isnotnull(d_year#27)) AND (d_moy#28 = 12)) AND (d_year#27 = 1998)) AND isnotnull(d_date_sk#23))
                  :     :     :     :        :           +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet
                  :     :     :     :        +- Project [c_customer_sk#14, c_current_addr_sk#16]
                  :     :     :     :           +- Filter (isnotnull(c_customer_sk#14) AND isnotnull(c_current_addr_sk#16))
                  :     :     :     :              +- Relation[c_customer_sk#14,c_customer_id#120,c_current_cdemo_sk#121,c_current_hdemo_sk#122,c_current_addr_sk#16,c_first_shipto_date_sk#123,c_first_sales_date_sk#124,c_salutation#125,c_first_name#126,c_last_name#127,c_preferred_cust_flag#128,c_birth_day#129,c_birth_month#130,c_birth_year#131,c_birth_country#132,c_login#133,c_email_address#134,c_last_review_date#135] parquet
                  :     :     :     +- Project [ss_sold_date_sk#22, ss_customer_sk#24, ss_ext_sales_price#15]
                  :     :     :        +- Filter (isnotnull(ss_customer_sk#24) AND isnotnull(ss_sold_date_sk#22))
                  :     :     :           +- Relation[ss_sold_date_sk#22,ss_sold_time_sk#136,ss_item_sk#137,ss_customer_sk#24,ss_cdemo_sk#138,ss_hdemo_sk#139,ss_addr_sk#140,ss_store_sk#141,ss_promo_sk#142,ss_ticket_number#143,ss_quantity#144,ss_wholesale_cost#145,ss_list_price#146,ss_sales_price#147,ss_ext_discount_amt#148,ss_ext_sales_price#15,ss_ext_wholesale_cost#149,ss_ext_list_price#150,ss_ext_tax#151,ss_coupon_amt#152,ss_net_paid#153,ss_net_paid_inc_tax#154,ss_net_profit#155] parquet
                  :     :     +- Project [ca_address_sk#17, ca_county#18, ca_state#20]
                  :     :        +- Filter ((isnotnull(ca_address_sk#17) AND isnotnull(ca_county#18)) AND isnotnull(ca_state#20))
                  :     :           +- Relation[ca_address_sk#17,ca_address_id#156,ca_street_number#157,ca_street_name#158,ca_street_type#159,ca_suite_number#160,ca_city#161,ca_county#18,ca_state#20,ca_zip#162,ca_country#163,ca_gmt_offset#164,ca_location_type#165] parquet
                  :     +- Project [s_county#19, s_state#21]
                  :        +- Filter (isnotnull(s_state#21) AND isnotnull(s_county#19))
                  :           +- Relation[s_store_sk#166,s_store_id#167,s_rec_start_date#168,s_rec_end_date#169,s_closed_date_sk#170,s_store_name#171,s_number_employees#172,s_floor_space#173,s_hours#174,s_manager#175,s_market_id#176,s_geography_class#177,s_market_desc#178,s_market_manager#179,s_division_id#180,s_division_name#181,s_company_id#182,s_company_name#183,s_street_number#184,s_street_name#185,s_street_type#186,s_suite_number#187,s_city#188,s_county#19,... 5 more fields] parquet
                  +- Project [d_date_sk#23]
                     +- Filter (((isnotnull(d_month_seq#25) AND (d_month_seq#25 >= scalar-subquery#8 [])) AND (d_month_seq#25 <= scalar-subquery#9 [])) AND isnotnull(d_date_sk#23))
                        :  :- Aggregate [(d_month_seq + 1)#26], [(d_month_seq + 1)#26]
                        :  :  +- Project [(d_month_seq#25 + 1) AS (d_month_seq + 1)#26]
                        :  :     +- Filter (((isnotnull(d_year#27) AND isnotnull(d_moy#28)) AND (d_year#27 = 1998)) AND (d_moy#28 = 12))
                        :  :        +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet
                        :  +- Aggregate [(d_month_seq + 3)#49], [(d_month_seq + 3)#49]
                        :     +- Project [(d_month_seq#25 + 3) AS (d_month_seq + 3)#49]
                        :        +- Filter (((isnotnull(d_year#27) AND isnotnull(d_moy#28)) AND (d_year#27 = 1998)) AND (d_moy#28 = 12))
                        :           +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet
                        +- Relation[d_date_sk#23,d_date_id#29,d_date#30,d_month_seq#25,d_week_seq#31,d_quarter_seq#32,d_year#27,d_dow#33,d_moy#28,d_dom#34,d_qoy#35,d_fy_year#36,d_fy_quarter_seq#37,d_fy_week_seq#38,d_day_name#39,d_quarter_name#40,d_holiday#41,d_weekend#42,d_following_holiday#43,d_first_dom#44,d_last_dom#45,d_same_day_ly#46,d_same_day_lq#47,d_current_day#48,... 4 more fields] parquet

== Physical Plan ==
TakeOrderedAndProject(limit=100, orderBy=[segment#10 ASC NULLS FIRST,num_customers#13 ASC NULLS FIRST], output=[segment#10,num_customers#13,segment_base#12])
+- *(13) HashAggregate(keys=[segment#10], functions=[count(1)], output=[segment#10, num_customers#13, segment_base#12])
   +- Exchange hashpartitioning(segment#10, 5), true, [id=#189]
      +- *(12) HashAggregate(keys=[segment#10], functions=[partial_count(1)], output=[segment#10, count#190])
         +- *(12) HashAggregate(keys=[c_customer_sk#14], functions=[sum(UnscaledValue(ss_ext_sales_price#15))], output=[segment#10])
            +- Exchange hashpartitioning(c_customer_sk#14, 5), true, [id=#191]
               +- *(11) HashAggregate(keys=[c_customer_sk#14], functions=[partial_sum(UnscaledValue(ss_ext_sales_price#15))], output=[c_customer_sk#14, sum#192])
                  +- *(11) Project [c_customer_sk#14, ss_ext_sales_price#15]
                     +- *(11) BroadcastHashJoin [ss_sold_date_sk#22], [d_date_sk#23], Inner, BuildRight, false
                        :- *(11) Project [c_customer_sk#14, ss_sold_date_sk#22, ss_ext_sales_price#15]
                        :  +- *(11) BroadcastHashJoin [ca_county#18, ca_state#20], [s_county#19, s_state#21], Inner, BuildRight, false
                        :     :- *(11) Project [c_customer_sk#14, ss_sold_date_sk#22, ss_ext_sales_price#15, ca_county#18, ca_state#20]
                        :     :  +- *(11) BroadcastHashJoin [c_current_addr_sk#16], [ca_address_sk#17], Inner, BuildRight, false
                        :     :     :- *(11) Project [c_customer_sk#14, c_current_addr_sk#16, ss_sold_date_sk#22, ss_ext_sales_price#15]
                        :     :     :  +- *(11) BroadcastHashJoin [c_customer_sk#14], [ss_customer_sk#24], Inner, BuildRight, false
                        :     :     :     :- *(11) HashAggregate(keys=[c_customer_sk#14, c_current_addr_sk#16], functions=[], output=[c_customer_sk#14, c_current_addr_sk#16])
                        :     :     :     :  +- Exchange hashpartitioning(c_customer_sk#14, c_current_addr_sk#16, 5), true, [id=#193]
                        :     :     :     :     +- *(6) HashAggregate(keys=[c_customer_sk#14, c_current_addr_sk#16], functions=[], output=[c_customer_sk#14, c_current_addr_sk#16])
                        :     :     :     :        +- *(6) Project [c_customer_sk#14, c_current_addr_sk#16]
                        :     :     :     :           +- *(6) BroadcastHashJoin [customer_sk#2], [c_customer_sk#14], Inner, BuildRight, false
                        :     :     :     :              :- *(6) Project [customer_sk#2]
                        :     :     :     :              :  +- *(6) BroadcastHashJoin [sold_date_sk#1], [d_date_sk#23], Inner, BuildRight, false
                        :     :     :     :              :     :- *(6) Project [sold_date_sk#1, customer_sk#2]
                        :     :     :     :              :     :  +- *(6) BroadcastHashJoin [item_sk#3], [i_item_sk#50], Inner, BuildRight, false
                        :     :     :     :              :     :     :- Union
                        :     :     :     :              :     :     :  :- *(1) Project [cs_sold_date_sk#53 AS sold_date_sk#1, cs_bill_customer_sk#54 AS customer_sk#2, cs_item_sk#55 AS item_sk#3]
                        :     :     :     :              :     :     :  :  +- *(1) Filter ((isnotnull(cs_item_sk#55) AND isnotnull(cs_sold_date_sk#53)) AND isnotnull(cs_bill_customer_sk#54))
                        :     :     :     :              :     :     :  :     +- *(1) ColumnarToRow
                        :     :     :     :              :     :     :  :        +- FileScan parquet default.catalog_sales[cs_sold_date_sk#53,cs_bill_customer_sk#54,cs_item_sk#55] Batched: true, DataFilters: [isnotnull(cs_item_sk#55), isnotnull(cs_sold_date_sk#53), isnotnull(cs_bill_customer_sk#54)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(cs_item_sk), IsNotNull(cs_sold_date_sk), IsNotNull(cs_bill_customer_sk)], ReadSchema: struct<cs_sold_date_sk:int,cs_bill_customer_sk:int,cs_item_sk:int>
                        :     :     :     :              :     :     :  +- *(2) Project [ws_sold_date_sk#77 AS sold_date_sk#4, ws_bill_customer_sk#78 AS customer_sk#5, ws_item_sk#79 AS item_sk#6]
                        :     :     :     :              :     :     :     +- *(2) Filter ((isnotnull(ws_item_sk#79) AND isnotnull(ws_sold_date_sk#77)) AND isnotnull(ws_bill_customer_sk#78))
                        :     :     :     :              :     :     :        +- *(2) ColumnarToRow
                        :     :     :     :              :     :     :           +- FileScan parquet default.web_sales[ws_sold_date_sk#77,ws_item_sk#79,ws_bill_customer_sk#78] Batched: true, DataFilters: [isnotnull(ws_item_sk#79), isnotnull(ws_sold_date_sk#77), isnotnull(ws_bill_customer_sk#78)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ws_item_sk), IsNotNull(ws_sold_date_sk), IsNotNull(ws_bill_customer_sk)], ReadSchema: struct<ws_sold_date_sk:int,ws_item_sk:int,ws_bill_customer_sk:int>
                        :     :     :     :              :     :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#194]
                        :     :     :     :              :     :        +- *(3) Project [i_item_sk#50]
                        :     :     :     :              :     :           +- *(3) Filter ((((isnotnull(i_category#51) AND isnotnull(i_class#52)) AND (i_category#51 = Women)) AND (i_class#52 = maternity)) AND isnotnull(i_item_sk#50))
                        :     :     :     :              :     :              +- *(3) ColumnarToRow
                        :     :     :     :              :     :                 +- FileScan parquet default.item[i_item_sk#50,i_class#52,i_category#51] Batched: true, DataFilters: [isnotnull(i_category#51), isnotnull(i_class#52), (i_category#51 = Women), (i_class#52 = mate..., Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(i_category), IsNotNull(i_class), EqualTo(i_category,Women), EqualTo(i_class,maternity)..., ReadSchema: struct<i_item_sk:int,i_class:string,i_category:string>
                        :     :     :     :              :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#195]
                        :     :     :     :              :        +- *(4) Project [d_date_sk#23]
                        :     :     :     :              :           +- *(4) Filter ((((isnotnull(d_moy#28) AND isnotnull(d_year#27)) AND (d_moy#28 = 12)) AND (d_year#27 = 1998)) AND isnotnull(d_date_sk#23))
                        :     :     :     :              :              +- *(4) ColumnarToRow
                        :     :     :     :              :                 +- FileScan parquet default.date_dim[d_date_sk#23,d_year#27,d_moy#28] Batched: true, DataFilters: [isnotnull(d_moy#28), isnotnull(d_year#27), (d_moy#28 = 12), (d_year#27 = 1998), isnotnull(d_date..., Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(d_moy), IsNotNull(d_year), EqualTo(d_moy,12), EqualTo(d_year,1998), IsNotNull(d_date_sk)], ReadSchema: struct<d_date_sk:int,d_year:int,d_moy:int>
                        :     :     :     :              +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#196]
                        :     :     :     :                 +- *(5) Project [c_customer_sk#14, c_current_addr_sk#16]
                        :     :     :     :                    +- *(5) Filter (isnotnull(c_customer_sk#14) AND isnotnull(c_current_addr_sk#16))
                        :     :     :     :                       +- *(5) ColumnarToRow
                        :     :     :     :                          +- FileScan parquet default.customer[c_customer_sk#14,c_current_addr_sk#16] Batched: true, DataFilters: [isnotnull(c_customer_sk#14), isnotnull(c_current_addr_sk#16)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(c_customer_sk), IsNotNull(c_current_addr_sk)], ReadSchema: struct<c_customer_sk:int,c_current_addr_sk:int>
                        :     :     :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[1, int, true] as bigint)),false), [id=#197]
                        :     :     :        +- *(7) Project [ss_sold_date_sk#22, ss_customer_sk#24, ss_ext_sales_price#15]
                        :     :     :           +- *(7) Filter (isnotnull(ss_customer_sk#24) AND isnotnull(ss_sold_date_sk#22))
                        :     :     :              +- *(7) ColumnarToRow
                        :     :     :                 +- FileScan parquet default.store_sales[ss_sold_date_sk#22,ss_customer_sk#24,ss_ext_sales_price#15] Batched: true, DataFilters: [isnotnull(ss_customer_sk#24), isnotnull(ss_sold_date_sk#22)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ss_customer_sk), IsNotNull(ss_sold_date_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_customer_sk:int,ss_ext_sales_price:decimal(7,2)>
                        :     :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#198]
                        :     :        +- *(8) Project [ca_address_sk#17, ca_county#18, ca_state#20]
                        :     :           +- *(8) Filter ((isnotnull(ca_address_sk#17) AND isnotnull(ca_county#18)) AND isnotnull(ca_state#20))
                        :     :              +- *(8) ColumnarToRow
                        :     :                 +- FileScan parquet default.customer_address[ca_address_sk#17,ca_county#18,ca_state#20] Batched: true, DataFilters: [isnotnull(ca_address_sk#17), isnotnull(ca_county#18), isnotnull(ca_state#20)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ca_address_sk), IsNotNull(ca_county), IsNotNull(ca_state)], ReadSchema: struct<ca_address_sk:int,ca_county:string,ca_state:string>
                        :     +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true], input[1, string, true]),false), [id=#199]
                        :        +- *(9) Project [s_county#19, s_state#21]
                        :           +- *(9) Filter (isnotnull(s_state#21) AND isnotnull(s_county#19))
                        :              +- *(9) ColumnarToRow
                        :                 +- FileScan parquet default.store[s_county#19,s_state#21] Batched: true, DataFilters: [isnotnull(s_state#21), isnotnull(s_county#19)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(s_state), IsNotNull(s_county)], ReadSchema: struct<s_county:string,s_state:string>
                        +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#200]
                           +- *(10) Project [d_date_sk#23]
                              +- *(10) Filter (((isnotnull(d_month_seq#25) AND (d_month_seq#25 >= Subquery scalar-subquery#8, [id=#201])) AND (d_month_seq#25 <= Subquery scalar-subquery#9, [id=#202])) AND isnotnull(d_date_sk#23))
                                 :  :- Subquery scalar-subquery#8, [id=#201]
                                 :  :  +- *(2) HashAggregate(keys=[(d_month_seq + 1)#26], functions=[], output=[(d_month_seq + 1)#26])
                                 :  :     +- Exchange hashpartitioning((d_month_seq + 1)#26, 5), true, [id=#203]
                                 :  :        +- *(1) HashAggregate(keys=[(d_month_seq + 1)#26], functions=[], output=[(d_month_seq + 1)#26])
                                 :  :           +- *(1) Project [(d_month_seq#25 + 1) AS (d_month_seq + 1)#26]
                                 :  :              +- *(1) Filter (((isnotnull(d_year#27) AND isnotnull(d_moy#28)) AND (d_year#27 = 1998)) AND (d_moy#28 = 12))
                                 :  :                 +- *(1) ColumnarToRow
                                 :  :                    +- FileScan parquet default.date_dim[d_month_seq#25,d_year#27,d_moy#28] Batched: true, DataFilters: [isnotnull(d_year#27), isnotnull(d_moy#28), (d_year#27 = 1998), (d_moy#28 = 12)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(d_year), IsNotNull(d_moy), EqualTo(d_year,1998), EqualTo(d_moy,12)], ReadSchema: struct<d_month_seq:int,d_year:int,d_moy:int>
                                 :  +- Subquery scalar-subquery#9, [id=#202]
                                 :     +- *(2) HashAggregate(keys=[(d_month_seq + 3)#49], functions=[], output=[(d_month_seq + 3)#49])
                                 :        +- Exchange hashpartitioning((d_month_seq + 3)#49, 5), true, [id=#204]
                                 :           +- *(1) HashAggregate(keys=[(d_month_seq + 3)#49], functions=[], output=[(d_month_seq + 3)#49])
                                 :              +- *(1) Project [(d_month_seq#25 + 3) AS (d_month_seq + 3)#49]
                                 :                 +- *(1) Filter (((isnotnull(d_year#27) AND isnotnull(d_moy#28)) AND (d_year#27 = 1998)) AND (d_moy#28 = 12))
                                 :                    +- *(1) ColumnarToRow
                                 :                       +- FileScan parquet default.date_dim[d_month_seq#25,d_year#27,d_moy#28] Batched: true, DataFilters: [isnotnull(d_year#27), isnotnull(d_moy#28), (d_year#27 = 1998), (d_moy#28 = 12)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(d_year), IsNotNull(d_moy), EqualTo(d_year,1998), EqualTo(d_moy,12)], ReadSchema: struct<d_month_seq:int,d_year:int,d_moy:int>
                                 +- *(10) ColumnarToRow
                                    +- FileScan parquet default.date_dim[d_date_sk#23,d_month_seq#25] Batched: true, DataFilters: [isnotnull(d_month_seq#25), isnotnull(d_date_sk#23)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(d_month_seq), IsNotNull(d_date_sk)], ReadSchema: struct<d_date_sk:int,d_month_seq:int>
